<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Turing Compiler Design (Outdated) – Turing.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../developers/contexts/submodel-condition/index.html" rel="next">
<link href="../../../developers/compiler/minituring-contexts/index.html" rel="prev">
<link href="../../..//assets/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-a6e161b2431e1f94a14e0f5d32135a3c.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-4a17e18fdf56099d4f6da1e105f33a53.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-a6e161b2431e1f94a14e0f5d32135a3c.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-dd36dd2691aefc3bcb9975107d61685a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-efbb2b21aef954ede5966910a3c52bd6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../../site_libs/bootstrap/bootstrap-dd36dd2691aefc3bcb9975107d61685a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Only add button if we're on a tutorial page
  const path = window.location.pathname;
  if (path.includes('/tutorials/') || path.includes('/usage/')) {
    // Extract the notebook name from the URL
    const pathParts = path.split('/');
    const section = pathParts[pathParts.length - 2];

    // Create download button
    const downloadBtn = document.createElement('a');
    downloadBtn.className = 'btn btn-primary download-notebook-btn';
    downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download as Notebook';

    // Generate GitHub raw URL for the notebook
    const baseUrl = 'https://raw.githubusercontent.com/TuringLang/docs/main';
    const notebookPath = path.replace('.html', '.ipynb');
    downloadBtn.href = baseUrl + notebookPath;
    downloadBtn.download = section + '.ipynb';

    // Insert button after title or in TOC area
    const tocTitle = document.querySelector('.toc-title');
    if (tocTitle) {
      tocTitle.parentNode.insertBefore(downloadBtn, tocTitle.nextSibling);
    } else {
      const articleHeader = document.querySelector('header.quarto-title-block');
      if (articleHeader) {
        articleHeader.appendChild(downloadBtn);
      }
    }
  }
});
</script>

<style>
.download-notebook-btn {
  display: inline-block;
  margin: 1rem 0;
  padding: 0.5rem 1rem;
  background-color: var(--bs-primary);
  color: white;
  text-decoration: none;
  border-radius: 0.25rem;
  font-size: 0.9rem;
}

.download-notebook-btn:hover {
  background-color: var(--bs-primary-dark);
  color: white;
  text-decoration: none;
}

.download-notebook-btn i {
  margin-right: 0.5rem;
}
</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>


<meta property="og:title" content="The Turing Language">
<meta property="og:description" content="Turing.jl is a probabilistic programming language and Bayesian modelling framework for the Julia programming language.">
<meta property="og:image" content="https://turinglang.org/docs/assets/images/turing-text-logo.jpg">
<meta property="og:site_name" content="Turing.jl">
<meta property="og:image:alt" content="Turing.jl Logo">
<meta property="og:locale" content="en_GB">
<meta name="twitter:title" content="Turing Compiler Design (Outdated) – Turing.jl">
<meta name="twitter:description" content="Turing.jl is a probabilistic programming language and Bayesian modelling framework for the Julia programming language.">
<meta name="twitter:image" content="https://turinglang.org/docs/assets/images/turing-text-logo.jpg">
<meta name="twitter:creator" content="@Hong_Ge2">
<meta name="twitter:site" content="@TuringLang">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../../assets/images/turing-logo.svg" alt="" class="navbar-logo light-content">
    <img src="../../../assets/images/turing-logo.svg" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../tutorials/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../faq/"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Libraries</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-v0.39" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">v0.39</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-v0.39">    
        <li>
    <a class="dropdown-item" href="https://turinglang.org/docs/changelog.html">
 <span class="dropdown-text">Changelog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://turinglang.org/docs/versions.html">
 <span class="dropdown-text">All Versions</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter-x"></i></a>
    <a href="https://discourse.julialang.org/c/domain/probprog/48" title="Turing Discourse" class="quarto-navigation-tool px-1" aria-label="Turing Discourse"><i class="bi bi-chat-dots"></i></a>
    <a href="https://julialang.slack.com/archives/CCYDC34A0" title="Turing Slack" class="quarto-navigation-tool px-1" aria-label="Turing Slack"><i class="bi bi-slack"></i></a>
    <a href="https://github.com/TuringLang" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../developers/contributing/index.html">Developers</a></li><li class="breadcrumb-item"><a href="../../../developers/compiler/model-manual/index.html">DynamicPPL’s Compiler</a></li><li class="breadcrumb-item"><a href="../../../developers/compiler/design-overview/index.html">Turing Compiler Design (Outdated)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../core-functionality/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core Functionality</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">User Guide</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/automatic-differentiation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/submodels/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Submodels</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/custom-distribution/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/probability-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Querying Model Probabilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/modifying-logprob/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modifying the Log Probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/tracking-extra-quantities/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tracking Extra Quantities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/mode-estimation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mode Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/sampler-visualisation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using External Samplers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../usage/troubleshooting/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Troubleshooting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/coin-flipping/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction: Coin Flipping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/gaussian-mixture-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-neural-networks/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/hidden-markov-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/infinite-mixture-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/bayesian-time-series-analysis/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/gaussian-processes-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Processes: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../tutorials/gaussian-process-latent-variable-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Developers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/contributing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">DynamicPPL’s Compiler</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/compiler/model-manual/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Manually Defining a Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/compiler/minituring-compiler/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation I: Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/compiler/minituring-contexts/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation II: Contexts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/compiler/design-overview/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Turing Compiler Design (Outdated)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">DynamicPPL Contexts</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/contexts/submodel-condition/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditioning and fixing in submodels</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Variable Transformations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/transforms/distributions/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributions and the Jacobian</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/transforms/bijectors/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bijectors in MCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/transforms/dynamicppl/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variable transformations in DynamicPPL</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Inference in Detail</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/inference/variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../developers/inference/implementing-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The model</a></li>
  </ul></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a>
  <ul class="collapse">
  <li><a href="#step-1-break-up-the-model-definition" id="toc-step-1-break-up-the-model-definition" class="nav-link" data-scroll-target="#step-1-break-up-the-model-definition">Step 1: Break up the model definition</a></li>
  <li><a href="#step-2-generate-the-body-of-the-internal-model-function" id="toc-step-2-generate-the-body-of-the-internal-model-function" class="nav-link" data-scroll-target="#step-2-generate-the-body-of-the-internal-model-function">Step 2: Generate the body of the internal model function</a></li>
  <li><a href="#step-3-replace-the-user-provided-function-body" id="toc-step-3-replace-the-user-provided-function-body" class="nav-link" data-scroll-target="#step-3-replace-the-user-provided-function-body">Step 3: Replace the user-provided function body</a></li>
  </ul></li>
  <li><a href="#varname" id="toc-varname" class="nav-link" data-scroll-target="#varname"><code>VarName</code></a></li>
  <li><a href="#varinfo" id="toc-varinfo" class="nav-link" data-scroll-target="#varinfo"><code>VarInfo</code></a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1">Overview</a></li>
  <li><a href="#metadata" id="toc-metadata" class="nav-link" data-scroll-target="#metadata"><code>Metadata</code></a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/docs/edit/main/developers/compiler/design-overview/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/docs/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../developers/contributing/index.html">Developers</a></li><li class="breadcrumb-item"><a href="../../../developers/compiler/model-manual/index.html">DynamicPPL’s Compiler</a></li><li class="breadcrumb-item"><a href="../../../developers/compiler/design-overview/index.html">Turing Compiler Design (Outdated)</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Turing Compiler Design (Outdated)</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this section, the current design of Turing’s model “compiler” is described which enables Turing to perform various types of Bayesian inference without changing the model definition. The “compiler” is essentially just a macro that rewrites the user’s model definition to a function that generates a <code>Model</code> struct that Julia’s dispatch can operate on and that Julia’s compiler can successfully do type inference on for efficient machine code generation.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The following terminology will be used in this section:</p>
<ul>
<li><code>D</code>: observed data variables conditioned upon in the posterior,</li>
<li><code>P</code>: parameter variables distributed according to the prior distributions, these will also be referred to as random variables,</li>
<li><code>Model</code>: a fully defined probabilistic model with input data</li>
</ul>
<p><code>Turing</code>’s <code>@model</code> macro rewrites the user-provided function definition such that it can be used to instantiate a <code>Model</code> by passing in the observed data <code>D</code>.</p>
<p>The following are the main jobs of the <code>@model</code> macro:</p>
<ol type="1">
<li>Parse <code>~</code> and <code>.~</code> lines, e.g.&nbsp;<code>y .~ Normal.(c*x, 1.0)</code></li>
<li>Figure out if a variable belongs to the data <code>D</code> and or to the parameters <code>P</code></li>
<li>Enable the handling of missing data variables in <code>D</code> when defining a <code>Model</code> and treating them as parameter variables in <code>P</code> instead</li>
<li>Enable the tracking of random variables using the data structures <code>VarName</code> and <code>VarInfo</code></li>
<li>Change <code>~</code>/<code>.~</code> lines with a variable in <code>P</code> on the LHS to a call to <code>tilde_assume</code> or <code>dot_tilde_assume</code></li>
<li>Change <code>~</code>/<code>.~</code> lines with a variable in <code>D</code> on the LHS to a call to <code>tilde_observe</code> or <code>dot_tilde_observe</code></li>
<li>Enable type stable automatic differentiation of the model using type parameters</li>
</ol>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>A <code>model::Model</code> is a callable struct that one can sample from by calling</p>
<div id="4" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(model<span class="op">::</span><span class="dt">Model</span>)([rng, varinfo, sampler, context])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>where <code>rng</code> is a random number generator (default: <code>Random.default_rng()</code>), <code>varinfo</code> is a data structure that stores information about the random variables (default: <code>DynamicPPL.VarInfo()</code>), <code>sampler</code> is a sampling algorithm (default: <code>DynamicPPL.SampleFromPrior()</code>), and <code>context</code> is a sampling context that can, e.g., modify how the log probability is accumulated (default: <code>DynamicPPL.DefaultContext()</code>).</p>
<p>Sampling resets the log joint probability of <code>varinfo</code> and increases the evaluation counter of <code>sampler</code>. If <code>context</code> is a <code>LikelihoodContext</code>, only the log likelihood of <code>D</code> will be accumulated, whereas with <code>PriorContext</code> only the log prior probability of <code>P</code> is. With the <code>DefaultContext</code> the log joint probability of both <code>P</code> and <code>D</code> is accumulated.</p>
<p>The <code>Model</code> struct contains the four internal fields <code>f</code>, <code>args</code>, <code>defaults</code>, and <code>context</code>. When <code>model::Model</code> is called, then the internal function <code>model.f</code> is called as <code>model.f(rng, varinfo, sampler, context, model.args...)</code> (for multithreaded sampling, instead of <code>varinfo</code> a threadsafe wrapper is passed to <code>model.f</code>). The positional and keyword arguments that were passed to the user-defined model function when the model was created are saved as a <code>NamedTuple</code> in <code>model.args</code>. The default values of the positional and keyword arguments of the user-defined model functions, if any, are saved as a <code>NamedTuple</code> in <code>model.defaults</code>. They are used for constructing model instances with different arguments by the <code>logprob</code> and <code>prob</code> string macros. The <code>context</code> variable sets an evaluation context that can be used to control for instance whether log probabilities should be evaluated for the prior, likelihood, or joint probability. By default it is set to evaluate the log joint.</p>
</section>
</section>
<section id="example" class="level1">
<h1>Example</h1>
<p>Let’s take the following model as an example:</p>
<div id="6" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">~</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">1.0</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    @. x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    x[<span class="fl">3</span>] <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The above call of the <code>@model</code> macro defines the function <code>gauss</code> with positional arguments <code>x</code>, <code>y</code>, and <code>::Type{TV}</code>, rewritten in such a way that every call of it returns a <code>model::Model</code>. Note that only the function body is modified by the <code>@model</code> macro, and the function signature is left untouched. It is also possible to implement models with keyword arguments such as</p>
<div id="8" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}; x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This would allow us to generate a model by calling <code>gauss(; x = rand(3))</code>.</p>
<p>If an argument has a default value <code>missing</code>, it is treated as a random variable. For variables which require an initialization because we need to loop or broadcast over its elements, such as <code>x</code> above, the following needs to be done:</p>
<div id="10" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="op">...</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note that since <code>gauss</code> behaves like a regular function it is possible to define additional dispatches in a second step as well. For instance, we could achieve the same behaviour by</p>
<div id="12" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(x, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">gauss</span>(<span class="op">::</span><span class="dt">Missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">gauss</span>(<span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>), y, TV)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If <code>x</code> is sampled as a whole from a distribution and not indexed, e.g., <code>x ~ Normal(...)</code> or <code>x ~ MvNormal(...)</code>, there is no need to initialize it in an <code>if</code>-block.</p>
<section id="step-1-break-up-the-model-definition" class="level2">
<h2 class="anchored" data-anchor-id="step-1-break-up-the-model-definition">Step 1: Break up the model definition</h2>
<p>First, the <code>@model</code> macro breaks up the user-provided function definition using <code>DynamicPPL.build_model_info</code>. This function returns a dictionary consisting of:</p>
<ul>
<li><code>allargs_exprs</code>: The expressions of the positional and keyword arguments, without default values.</li>
<li><code>allargs_syms</code>: The names of the positional and keyword arguments, e.g., <code>[:x, :y, :TV]</code> above.</li>
<li><code>allargs_namedtuple</code>: An expression that constructs a <code>NamedTuple</code> of the positional and keyword arguments, e.g., <code>:((x = x, y = y, TV = TV))</code> above.</li>
<li><code>defaults_namedtuple</code>: An expression that constructs a <code>NamedTuple</code> of the default positional and keyword arguments, if any, e.g., <code>:((x = missing, y = 1, TV = Vector{Float64}))</code> above.</li>
<li><code>modeldef</code>: A dictionary with the name, arguments, and function body of the model definition, as returned by <code>MacroTools.splitdef</code>.</li>
</ul>
</section>
<section id="step-2-generate-the-body-of-the-internal-model-function" class="level2">
<h2 class="anchored" data-anchor-id="step-2-generate-the-body-of-the-internal-model-function">Step 2: Generate the body of the internal model function</h2>
<p>In a second step, <code>DynamicPPL.generate_mainbody</code> generates the main part of the transformed function body using the user-provided function body and the provided function arguments, without default values, for figuring out if a variable denotes an observation or a random variable. Hereby the function <code>DynamicPPL.generate_tilde</code> replaces the <code>L ~ R</code> lines in the model and the function <code>DynamicPPL.generate_dot_tilde</code> replaces the <code>@. L ~ R</code> and <code>L .~ R</code> lines in the model.</p>
<p>In the above example, <code>p[1] ~ InverseGamma(2, 3)</code> is replaced with something similar to</p>
<div id="14" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:6 =#</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> <span class="op">=</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#325"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>p, ((<span class="fl">1</span>,),))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#326"</span> <span class="op">=</span> ((<span class="fl">1</span>,),)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">=</span> (DynamicPPL.tilde_assume)(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        _rng,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        _context,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        _sampler,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##tmpright#323"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##vn#325"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##inds#326"</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        _varinfo,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Here the first line is a so-called line number node that enables more helpful error messages by providing users with the exact location of the error in their model definition. Then the right hand side (RHS) of the <code>~</code> is assigned to a variable (with an automatically generated name). We check that the RHS is a distribution or an array of distributions, otherwise an error is thrown. Next we extract a compact representation of the variable with its name and index (or indices). Finally, the <code>~</code> expression is replaced with a call to <code>DynamicPPL.tilde_assume</code> since the compiler figured out that <code>p[1]</code> is a random variable using the following heuristic:</p>
<ol type="1">
<li>If the symbol on the LHS of <code>~</code>, <code>:p</code> in this case, is not among the arguments to the model, <code>(:x, :y, :T)</code> in this case, it is a random variable.</li>
<li>If the symbol on the LHS of <code>~</code>, <code>:p</code> in this case, is among the arguments to the model but has a value of <code>missing</code>, it is a random variable.</li>
<li>If the value of the LHS of <code>~</code>, <code>p[1]</code> in this case, is <code>missing</code>, then it is a random variable.</li>
<li>Otherwise, it is treated as an observation.</li>
</ol>
<p>The <code>DynamicPPL.tilde_assume</code> function takes care of sampling the random variable, if needed, and updating its value and the accumulated log joint probability in the <code>_varinfo</code> object. If <code>L ~ R</code> is an observation, <code>DynamicPPL.tilde_observe</code> is called with the same arguments except the random number generator <code>_rng</code> (since observations are never sampled).</p>
<p>A similar transformation is performed for expressions of the form <code>@. L ~ R</code> and <code>L .~ R</code>. For instance, <code>@. x[1:2] ~ Normal(p[2], sqrt(p[1]))</code> is replaced with</p>
<div id="16" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:8 =#</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> <span class="op">=</span> <span class="fu">Normal</span>.(p[<span class="fl">2</span>], <span class="fu">sqrt</span>.(p[<span class="fl">1</span>]))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#333"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#334"</span> <span class="op">=</span> ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##isassumption#335"</span> <span class="op">=</span> <span class="cf">begin</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> var<span class="st">"##vn#336"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> !((DynamicPPL.inargnames)(var<span class="st">"##vn#336"</span>, _model)) <span class="op">||</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                (DynamicPPL.inmissings)(var<span class="st">"##vn#336"</span>, _model)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                <span class="cn">true</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var<span class="st">"##isassumption#335"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">.=</span> (DynamicPPL.dot_tilde_assume)(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            _rng,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        (DynamicPPL.dot_tilde_observe)(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The main difference in the expanded code between <code>L ~ R</code> and <code>@. L ~ R</code> is that the former doesn’t assume <code>L</code> to be defined, it can be a new Julia variable in the scope, while the latter assumes <code>L</code> already exists. Moreover, <code>DynamicPPL.dot_tilde_assume</code> and <code>DynamicPPL.dot_tilde_observe</code> are called instead of <code>DynamicPPL.tilde_assume</code> and <code>DynamicPPL.tilde_observe</code>.</p>
</section>
<section id="step-3-replace-the-user-provided-function-body" class="level2">
<h2 class="anchored" data-anchor-id="step-3-replace-the-user-provided-function-body">Step 3: Replace the user-provided function body</h2>
<p>Finally, we replace the user-provided function body using <code>DynamicPPL.build_output</code>. This function uses <code>MacroTools.combinedef</code> to reassemble the user-provided function with a new function body. In the modified function body an anonymous function is created whose function body was generated in step 2 above and whose arguments are</p>
<ul>
<li>a random number generator <code>_rng</code>,</li>
<li>a model <code>_model</code>,</li>
<li>a datastructure <code>_varinfo</code>,</li>
<li>a sampler <code>_sampler</code>,</li>
<li>a sampling context <code>_context</code>,</li>
<li>and all positional and keyword arguments of the user-provided model function as positional arguments without any default values. Finally, in the new function body a <code>model::Model</code> with this anonymous function as internal function is returned.</li>
</ul>
</section>
</section>
<section id="varname" class="level1">
<h1><code>VarName</code></h1>
<p>In order to track random variables in the sampling process, <code>Turing</code> uses the <code>VarName</code> struct which acts as a random variable identifier generated at runtime. The <code>VarName</code> of a random variable is generated from the expression on the LHS of a <code>~</code> statement when the symbol on the LHS is in the set <code>P</code> of unobserved random variables. Every <code>VarName</code> instance has a type parameter <code>sym</code> which is the symbol of the Julia variable in the model that the random variable belongs to. For example, <code>x[1] ~ Normal()</code> will generate an instance of <code>VarName{:x}</code> assuming <code>x</code> is an unobserved random variable. Every <code>VarName</code> also has a field <code>indexing</code>, which stores the indices required to access the random variable from the Julia variable indicated by <code>sym</code> as a tuple of tuples. Each element of the tuple thereby contains the indices of one indexing operation (<code>VarName</code> also supports hierarchical arrays and range indexing). Some examples:</p>
<ul>
<li><code>x ~ Normal()</code> will generate a <code>VarName(:x, ())</code>.</li>
<li><code>x[1] ~ Normal()</code> will generate a <code>VarName(:x, ((1,),))</code>.</li>
<li><code>x[:,1] ~ MvNormal(zeros(2), I)</code> will generate a <code>VarName(:x, ((Colon(), 1),))</code>.</li>
<li><code>x[:,1][1+1] ~ Normal()</code> will generate a <code>VarName(:x, ((Colon(), 1), (2,)))</code>.</li>
</ul>
<p>The easiest way to manually construct a <code>VarName</code> is to use the <code>@varname</code> macro on an indexing expression, which will take the <code>sym</code> value from the actual variable name, and put the index values appropriately into the constructor.</p>
</section>
<section id="varinfo" class="level1">
<h1><code>VarInfo</code></h1>
<section id="overview-1" class="level2">
<h2 class="anchored" data-anchor-id="overview-1">Overview</h2>
<p><code>VarInfo</code> is the data structure in <code>Turing</code> that facilitates tracking random variables and certain metadata about them that are required for sampling. For instance, the distribution of every random variable is stored in <code>VarInfo</code> because we need to know the support of every random variable when sampling using HMC for example. Random variables whose distributions have a constrained support are transformed using a bijector from <a href="https://github.com/TuringLang/Bijectors.jl">Bijectors.jl</a> so that the sampling happens in the unconstrained space. Different samplers require different metadata about the random variables.</p>
<p>The definition of <code>VarInfo</code> in <code>Turing</code> is:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> VarInfo{Tmeta, Tlogp} <span class="op">&lt;:</span><span class="dt"> AbstractVarInfo</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">::</span><span class="dt">Tmeta</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    logp<span class="op">::</span><span class="dt">Base.RefValue{Tlogp}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    num_produce<span class="op">::</span><span class="dt">Base.RefValue{Int}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Based on the type of <code>metadata</code>, the <code>VarInfo</code> is either aliased <code>UntypedVarInfo</code> or <code>TypedVarInfo</code>. <code>metadata</code> can be either a subtype of the union type <code>Metadata</code> or a <code>NamedTuple</code> of multiple such subtypes. Let <code>vi</code> be an instance of <code>VarInfo</code>. If <code>vi isa VarInfo{&lt;:Metadata}</code>, then it is called an <code>UntypedVarInfo</code>. If <code>vi isa VarInfo{&lt;:NamedTuple}</code>, then <code>vi.metadata</code> would be a <code>NamedTuple</code> mapping each symbol in <code>P</code> to an instance of <code>Metadata</code>. <code>vi</code> would then be called a <code>TypedVarInfo</code>. The other fields of <code>VarInfo</code> include <code>logp</code> which is used to accumulate the log probability or log probability density of the variables in <code>P</code> and <code>D</code>. <code>num_produce</code> keeps track of how many observations have been made in the model so far. This is incremented when running a <code>~</code> statement when the symbol on the LHS is in <code>D</code>.</p>
</section>
<section id="metadata" class="level2">
<h2 class="anchored" data-anchor-id="metadata"><code>Metadata</code></h2>
<p>The <code>Metadata</code> struct stores some metadata about the random variables sampled. This helps query certain information about a variable such as: its distribution, which samplers sample this variable, its value and whether this value is transformed to real space or not. Let <code>md</code> be an instance of <code>Metadata</code>:</p>
<ul>
<li><code>md.vns</code> is the vector of all <code>VarName</code> instances. Let <code>vn</code> be an arbitrary element of <code>md.vns</code></li>
<li><code>md.idcs</code> is the dictionary that maps each <code>VarName</code> instance to its index in <code>md.vns</code>, <code>md.ranges</code>, <code>md.dists</code>, <code>md.orders</code> and <code>md.flags</code>.</li>
<li><code>md.vns[md.idcs[vn]] == vn</code>.</li>
<li><code>md.dists[md.idcs[vn]]</code> is the distribution of <code>vn</code>.</li>
<li><code>md.gids[md.idcs[vn]]</code> is the set of algorithms used to sample <code>vn</code>. This was used by the Gibbs sampler. Since Turing v0.36 it is unused and will eventually be deleted.</li>
<li><code>md.orders[md.idcs[vn]]</code> is the number of <code>observe</code> statements before <code>vn</code> is sampled.</li>
<li><code>md.ranges[md.idcs[vn]]</code> is the index range of <code>vn</code> in <code>md.vals</code>.</li>
<li><code>md.vals[md.ranges[md.idcs[vn]]]</code> is the linearized vector of values of corresponding to <code>vn</code>.</li>
<li><code>md.flags</code> is a dictionary of true/false flags. <code>md.flags[flag][md.idcs[vn]]</code> is the value of <code>flag</code> corresponding to <code>vn</code>.</li>
</ul>
<p>Note that in order to make <code>md::Metadata</code> type stable, all the <code>md.vns</code> must have the same symbol and distribution type. However, one can have a single Julia variable, e.g.&nbsp;<code>x</code>, that is a matrix or a hierarchical array sampled in partitions, e.g.&nbsp;<code>x[1][:] ~ MvNormal(zeros(2), I); x[2][:] ~ MvNormal(ones(2), I)</code>. The symbol <code>x</code> can still be managed by a single <code>md::Metadata</code> without hurting the type stability since all the distributions on the RHS of <code>~</code> are of the same type.</p>
<p>However, in <code>Turing</code> models one cannot have this restriction, so we must use a type unstable <code>Metadata</code> if we want to use one <code>Metadata</code> instance for the whole model. This is what <code>UntypedVarInfo</code> does. A type unstable <code>Metadata</code> will still work but will have inferior performance.</p>
<p>To strike a balance between flexibility and performance when constructing the <code>spl::Sampler</code> instance, the model is first run by sampling the parameters in <code>P</code> from their priors using an <code>UntypedVarInfo</code>, i.e.&nbsp;a type unstable <code>Metadata</code> is used for all the variables. Then once all the symbols and distribution types have been identified, a <code>vi::TypedVarInfo</code> is constructed where <code>vi.metadata</code> is a <code>NamedTuple</code> mapping each symbol in <code>P</code> to a specialized instance of <code>Metadata</code>. So as long as each symbol in <code>P</code> is sampled from only one type of distributions, <code>vi::TypedVarInfo</code> will have fully concretely typed fields which brings out the peak performance of Julia.</p>


<!-- -->

</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/turinglang\.org\/docs");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../developers/compiler/minituring-contexts/index.html" class="pagination-link" aria-label="A Mini Turing Implementation II: Contexts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">A Mini Turing Implementation II: Contexts</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../developers/contexts/submodel-condition/index.html" class="pagination-link" aria-label="Conditioning and fixing in submodels">
        <span class="nav-page-text">Conditioning and fixing in submodels</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Turing Compiler Design (Outdated)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="an">aliases:</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - ../../../tutorials/docs-05-for-developers-compiler/index.html</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">instantiate</span>();</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>In this section, the current design of Turing's model "compiler" is described which enables Turing to perform various types of Bayesian inference without changing the model definition. The "compiler" is essentially just a macro that rewrites the user's model definition to a function that generates a <span class="in">`Model`</span> struct that Julia's dispatch can operate on and that Julia's compiler can successfully do type inference on for efficient machine code generation.</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>The following terminology will be used in this section:</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`D`</span>: observed data variables conditioned upon in the posterior,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`P`</span>: parameter variables distributed according to the prior distributions, these will also be referred to as random variables,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`Model`</span>: a fully defined probabilistic model with input data</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="in">`Turing`</span>'s <span class="in">`@model`</span> macro rewrites the user-provided function definition such that it can be used to instantiate a <span class="in">`Model`</span> by passing in the observed data <span class="in">`D`</span>.</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>The following are the main jobs of the <span class="in">`@model`</span> macro:</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="ss"> 1. </span>Parse <span class="in">`~`</span> and <span class="in">`.~`</span> lines, e.g. <span class="in">`y .~ Normal.(c*x, 1.0)`</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="ss"> 2. </span>Figure out if a variable belongs to the data <span class="in">`D`</span> and or to the parameters <span class="in">`P`</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="ss"> 3. </span>Enable the handling of missing data variables in <span class="in">`D`</span> when defining a <span class="in">`Model`</span> and treating them as parameter variables in <span class="in">`P`</span> instead</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="ss"> 4. </span>Enable the tracking of random variables using the data structures <span class="in">`VarName`</span> and <span class="in">`VarInfo`</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="ss"> 5. </span>Change <span class="in">`~`</span>/<span class="in">`.~`</span> lines with a variable in <span class="in">`P`</span> on the LHS to a call to <span class="in">`tilde_assume`</span> or <span class="in">`dot_tilde_assume`</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="ss"> 6. </span>Change <span class="in">`~`</span>/<span class="in">`.~`</span> lines with a variable in <span class="in">`D`</span> on the LHS to a call to <span class="in">`tilde_observe`</span> or <span class="in">`dot_tilde_observe`</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="ss"> 7. </span>Enable type stable automatic differentiation of the model using type parameters</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="fu">## The model</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>A <span class="in">`model::Model`</span> is a callable struct that one can sample from by calling</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>(model<span class="op">::</span><span class="dt">Model</span>)([rng, varinfo, sampler, context])</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>where <span class="in">`rng`</span> is a random number generator (default: <span class="in">`Random.default_rng()`</span>), <span class="in">`varinfo`</span> is a data structure that stores information</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>about the random variables (default: <span class="in">`DynamicPPL.VarInfo()`</span>), <span class="in">`sampler`</span> is a sampling algorithm (default: <span class="in">`DynamicPPL.SampleFromPrior()`</span>),</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>and <span class="in">`context`</span> is a sampling context that can, e.g., modify how the log probability is accumulated (default: <span class="in">`DynamicPPL.DefaultContext()`</span>).</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>Sampling resets the log joint probability of <span class="in">`varinfo`</span> and increases the evaluation counter of <span class="in">`sampler`</span>. If <span class="in">`context`</span> is a <span class="in">`LikelihoodContext`</span>,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>only the log likelihood of <span class="in">`D`</span> will be accumulated, whereas with <span class="in">`PriorContext`</span> only the log prior probability of <span class="in">`P`</span> is. With the <span class="in">`DefaultContext`</span> the log joint probability of both <span class="in">`P`</span> and <span class="in">`D`</span> is accumulated.</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Model`</span> struct contains the four internal fields <span class="in">`f`</span>, <span class="in">`args`</span>, <span class="in">`defaults`</span>, and <span class="in">`context`</span>.</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>When <span class="in">`model::Model`</span> is called, then the internal function <span class="in">`model.f`</span> is called as <span class="in">`model.f(rng, varinfo, sampler, context, model.args...)`</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>(for multithreaded sampling, instead of <span class="in">`varinfo`</span> a threadsafe wrapper is passed to <span class="in">`model.f`</span>).</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>The positional and keyword arguments that were passed to the user-defined model function when the model was created are saved as a <span class="in">`NamedTuple`</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>in <span class="in">`model.args`</span>. The default values of the positional and keyword arguments of the user-defined model functions, if any, are saved as a <span class="in">`NamedTuple`</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>in <span class="in">`model.defaults`</span>. They are used for constructing model instances with different arguments by the <span class="in">`logprob`</span> and <span class="in">`prob`</span> string macros.</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>The <span class="in">`context`</span> variable sets an evaluation context that can be used to control for instance whether log probabilities should be evaluated for the prior, likelihood, or joint probability. By default it is set to evaluate the log joint.</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="fu"># Example</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>Let's take the following model as an example:</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">~</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">1.0</span>)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    @. x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    x[<span class="fl">3</span>] <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>The above call of the <span class="in">`@model`</span> macro defines the function <span class="in">`gauss`</span> with positional arguments <span class="in">`x`</span>, <span class="in">`y`</span>, and <span class="in">`::Type{TV}`</span>, rewritten in</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>such a way that every call of it returns a <span class="in">`model::Model`</span>. Note that only the function body is modified by the <span class="in">`@model`</span> macro, and the</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>function signature is left untouched. It is also possible to implement models with keyword arguments such as</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}; x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>This would allow us to generate a model by calling <span class="in">`gauss(; x = rand(3))`</span>.</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>If an argument has a default value <span class="in">`missing`</span>, it is treated as a random variable. For variables which require an initialization because we</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>need to loop or broadcast over its elements, such as <span class="in">`x`</span> above, the following needs to be done:</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="op">...</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>Note that since <span class="in">`gauss`</span> behaves like a regular function it is possible to define additional dispatches in a second step as well. For</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>instance, we could achieve the same behaviour by</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(x, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">gauss</span>(<span class="op">::</span><span class="dt">Missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">gauss</span>(<span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>), y, TV)</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>If <span class="in">`x`</span> is sampled as a whole from a distribution and not indexed, e.g., <span class="in">`x ~ Normal(...)`</span> or <span class="in">`x ~ MvNormal(...)`</span>,</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>there is no need to initialize it in an <span class="in">`if`</span>-block.</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Break up the model definition</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>First, the <span class="in">`@model`</span> macro breaks up the user-provided function definition using <span class="in">`DynamicPPL.build_model_info`</span>. This function</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>returns a dictionary consisting of:</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`allargs_exprs`</span>: The expressions of the positional and keyword arguments, without default values.</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`allargs_syms`</span>: The names of the positional and keyword arguments, e.g., <span class="in">`[:x, :y, :TV]`</span> above.</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`allargs_namedtuple`</span>: An expression that constructs a <span class="in">`NamedTuple`</span> of the positional and keyword arguments, e.g., <span class="in">`:((x = x, y = y, TV = TV))`</span> above.</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`defaults_namedtuple`</span>: An expression that constructs a <span class="in">`NamedTuple`</span> of the default positional and keyword arguments, if any, e.g., <span class="in">`:((x = missing, y = 1, TV = Vector{Float64}))`</span> above.</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`modeldef`</span>: A dictionary with the name, arguments, and function body of the model definition, as returned by <span class="in">`MacroTools.splitdef`</span>.</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Generate the body of the internal model function</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>In a second step, <span class="in">`DynamicPPL.generate_mainbody`</span> generates the main part of the transformed function body using the user-provided function body</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>and the provided function arguments, without default values, for figuring out if a variable denotes an observation or a random variable.</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>Hereby the function <span class="in">`DynamicPPL.generate_tilde`</span> replaces the <span class="in">`L ~ R`</span> lines in the model and the function <span class="in">`DynamicPPL.generate_dot_tilde`</span> replaces</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>the <span class="in">`@. L ~ R`</span> and <span class="in">`L .~ R`</span> lines in the model.</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>In the above example, <span class="in">`p[1] ~ InverseGamma(2, 3)`</span> is replaced with something similar to</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:6 =#</span></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> <span class="op">=</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#325"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>p, ((<span class="fl">1</span>,),))</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#326"</span> <span class="op">=</span> ((<span class="fl">1</span>,),)</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">=</span> (DynamicPPL.tilde_assume)(</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>        _rng,</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>        _context,</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>        _sampler,</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##tmpright#323"</span>,</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##vn#325"</span>,</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##inds#326"</span>,</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>        _varinfo,</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>Here the first line is a so-called line number node that enables more helpful error messages by providing users with the exact location</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>of the error in their model definition. Then the right hand side (RHS) of the <span class="in">`~`</span> is assigned to a variable (with an automatically generated name).</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>We check that the RHS is a distribution or an array of distributions, otherwise an error is thrown.</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>Next we extract a compact representation of the variable with its name and index (or indices). Finally, the <span class="in">`~`</span> expression is replaced with</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>a call to <span class="in">`DynamicPPL.tilde_assume`</span> since the compiler figured out that <span class="in">`p[1]`</span> is a random variable using the following</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>heuristic:</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a><span class="ss"> 1. </span>If the symbol on the LHS of <span class="in">`~`</span>, <span class="in">`:p`</span> in this case, is not among the arguments to the model, <span class="in">`(:x, :y, :T)`</span> in this case, it is a random variable.</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a><span class="ss"> 2. </span>If the symbol on the LHS of <span class="in">`~`</span>, <span class="in">`:p`</span> in this case, is among the arguments to the model but has a value of <span class="in">`missing`</span>, it is a random variable.</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a><span class="ss"> 3. </span>If the value of the LHS of <span class="in">`~`</span>, <span class="in">`p[1]`</span> in this case, is <span class="in">`missing`</span>, then it is a random variable.</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a><span class="ss"> 4. </span>Otherwise, it is treated as an observation.</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>The <span class="in">`DynamicPPL.tilde_assume`</span> function takes care of sampling the random variable, if needed, and updating its value and the accumulated log joint</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>probability in the <span class="in">`_varinfo`</span> object. If <span class="in">`L ~ R`</span> is an observation, <span class="in">`DynamicPPL.tilde_observe`</span> is called with the same arguments except the</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>random number generator <span class="in">`_rng`</span> (since observations are never sampled).</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>A similar transformation is performed for expressions of the form <span class="in">`@. L ~ R`</span> and <span class="in">`L .~ R`</span>. For instance,</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a><span class="in">`@. x[1:2] ~ Normal(p[2], sqrt(p[1]))`</span> is replaced with</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:8 =#</span></span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> <span class="op">=</span> <span class="fu">Normal</span>.(p[<span class="fl">2</span>], <span class="fu">sqrt</span>.(p[<span class="fl">1</span>]))</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#333"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#334"</span> <span class="op">=</span> ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),)</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##isassumption#335"</span> <span class="op">=</span> <span class="cf">begin</span></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> var<span class="st">"##vn#336"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> !((DynamicPPL.inargnames)(var<span class="st">"##vn#336"</span>, _model)) <span class="op">||</span></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>                (DynamicPPL.inmissings)(var<span class="st">"##vn#336"</span>, _model)</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>                <span class="cn">true</span></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>                x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var<span class="st">"##isassumption#335"</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>        x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">.=</span> (DynamicPPL.dot_tilde_assume)(</span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>            _rng,</span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>        (DynamicPPL.dot_tilde_observe)(</span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>The main difference in the expanded code between <span class="in">`L ~ R`</span> and <span class="in">`@. L ~ R`</span> is that the former doesn't assume <span class="in">`L`</span> to be defined, it can be a new Julia variable in the scope, while the latter assumes <span class="in">`L`</span> already exists. Moreover, <span class="in">`DynamicPPL.dot_tilde_assume`</span> and <span class="in">`DynamicPPL.dot_tilde_observe`</span> are called</span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>instead of <span class="in">`DynamicPPL.tilde_assume`</span> and <span class="in">`DynamicPPL.tilde_observe`</span>.</span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Replace the user-provided function body</span></span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>Finally, we replace the user-provided function body using <span class="in">`DynamicPPL.build_output`</span>. This function uses <span class="in">`MacroTools.combinedef`</span> to reassemble</span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>the user-provided function with a new function body. In the modified function body an anonymous function is created whose function body</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>was generated in step 2 above and whose arguments are</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>a random number generator <span class="in">`_rng`</span>,</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>a model <span class="in">`_model`</span>,</span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>a datastructure <span class="in">`_varinfo`</span>,</span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>a sampler <span class="in">`_sampler`</span>,</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>a sampling context <span class="in">`_context`</span>,</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>and all positional and keyword arguments of the user-provided model function as positional arguments</span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>    without any default values. Finally, in the new function body a <span class="in">`model::Model`</span> with this anonymous function as internal function is returned.</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a><span class="fu"># `VarName`</span></span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>In order to track random variables in the sampling process, <span class="in">`Turing`</span> uses the <span class="in">`VarName`</span> struct which acts as a random variable identifier generated at runtime. The <span class="in">`VarName`</span> of a random variable is generated from the expression on the LHS of a <span class="in">`~`</span> statement when the symbol on the LHS is in the set <span class="in">`P`</span> of unobserved random variables. Every <span class="in">`VarName`</span> instance has a type parameter <span class="in">`sym`</span> which is the symbol of the Julia variable in the model that the random variable belongs to. For example, <span class="in">`x[1] ~ Normal()`</span> will generate an instance of <span class="in">`VarName{:x}`</span> assuming <span class="in">`x`</span> is an unobserved random variable. Every <span class="in">`VarName`</span> also has a field <span class="in">`indexing`</span>, which stores the indices required to access the random variable from the Julia variable indicated by <span class="in">`sym`</span> as a tuple of tuples.  Each element of the tuple thereby contains the indices of one indexing operation (<span class="in">`VarName`</span> also supports hierarchical arrays and range indexing). Some examples:</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`x ~ Normal()`</span> will generate a <span class="in">`VarName(:x, ())`</span>.</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`x[1] ~ Normal()`</span> will generate a <span class="in">`VarName(:x, ((1,),))`</span>.</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`x[:,1] ~ MvNormal(zeros(2), I)`</span> will generate a <span class="in">`VarName(:x, ((Colon(), 1),))`</span>.</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`x[:,1][1+1] ~ Normal()`</span> will generate a <span class="in">`VarName(:x, ((Colon(), 1), (2,)))`</span>.</span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>The easiest way to manually construct a <span class="in">`VarName`</span> is to use the <span class="in">`@varname`</span> macro on an indexing expression, which will take the <span class="in">`sym`</span> value from the actual variable name, and put the index values appropriately into the constructor.</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a><span class="fu"># `VarInfo`</span></span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a><span class="in">`VarInfo`</span> is the data structure in <span class="in">`Turing`</span> that facilitates tracking random variables and certain metadata about them that are required for sampling. For instance, the distribution of every random variable is stored in <span class="in">`VarInfo`</span> because we need to know the support of every random variable when sampling using HMC for example. Random variables whose distributions have a constrained support are transformed using a bijector from <span class="co">[</span><span class="ot">Bijectors.jl</span><span class="co">](https://github.com/TuringLang/Bijectors.jl)</span> so that the sampling happens in the unconstrained space. Different samplers require different metadata about the random variables.</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>The definition of <span class="in">`VarInfo`</span> in <span class="in">`Turing`</span> is:</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> VarInfo{Tmeta, Tlogp} <span class="op">&lt;:</span><span class="dt"> AbstractVarInfo</span></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">::</span><span class="dt">Tmeta</span></span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>    logp<span class="op">::</span><span class="dt">Base.RefValue{Tlogp}</span></span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>    num_produce<span class="op">::</span><span class="dt">Base.RefValue{Int}</span></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>Based on the type of <span class="in">`metadata`</span>, the <span class="in">`VarInfo`</span> is either aliased <span class="in">`UntypedVarInfo`</span> or <span class="in">`TypedVarInfo`</span>. <span class="in">`metadata`</span> can be either a subtype of the union type <span class="in">`Metadata`</span> or a <span class="in">`NamedTuple`</span> of multiple such subtypes. Let <span class="in">`vi`</span> be an instance of <span class="in">`VarInfo`</span>. If <span class="in">`vi isa VarInfo{&lt;:Metadata}`</span>, then it is called an <span class="in">`UntypedVarInfo`</span>. If <span class="in">`vi isa VarInfo{&lt;:NamedTuple}`</span>, then <span class="in">`vi.metadata`</span> would be a <span class="in">`NamedTuple`</span> mapping each symbol in <span class="in">`P`</span> to an instance of <span class="in">`Metadata`</span>. <span class="in">`vi`</span> would then be called a <span class="in">`TypedVarInfo`</span>. The other fields of <span class="in">`VarInfo`</span> include <span class="in">`logp`</span> which is used to accumulate the log probability or log probability density of the variables in <span class="in">`P`</span> and <span class="in">`D`</span>. <span class="in">`num_produce`</span> keeps track of how many observations have been made in the model so far. This is incremented when running a <span class="in">`~`</span> statement when the symbol on the LHS is in <span class="in">`D`</span>.</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a><span class="fu">## `Metadata`</span></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Metadata`</span> struct stores some metadata about the random variables sampled. This helps</span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>query certain information about a variable such as: its distribution, which samplers</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>sample this variable, its value and whether this value is transformed to real space or</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>not. Let <span class="in">`md`</span> be an instance of <span class="in">`Metadata`</span>:</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.vns`</span> is the vector of all <span class="in">`VarName`</span> instances. Let <span class="in">`vn`</span> be an arbitrary element of <span class="in">`md.vns`</span></span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.idcs`</span> is the dictionary that maps each <span class="in">`VarName`</span> instance to its index in</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>    <span class="in">`md.vns`</span>, <span class="in">`md.ranges`</span>, <span class="in">`md.dists`</span>, <span class="in">`md.orders`</span> and <span class="in">`md.flags`</span>.</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.vns[md.idcs[vn]] == vn`</span>.</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.dists[md.idcs[vn]]`</span> is the distribution of <span class="in">`vn`</span>.</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.gids[md.idcs[vn]]`</span> is the set of algorithms used to sample <span class="in">`vn`</span>. This was used by the Gibbs sampler. Since Turing v0.36 it is unused and will eventually be deleted.</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.orders[md.idcs[vn]]`</span> is the number of <span class="in">`observe`</span> statements before <span class="in">`vn`</span> is sampled.</span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.ranges[md.idcs[vn]]`</span> is the index range of <span class="in">`vn`</span> in <span class="in">`md.vals`</span>.</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.vals[md.ranges[md.idcs[vn]]]`</span> is the linearized vector of values of corresponding to <span class="in">`vn`</span>.</span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`md.flags`</span> is a dictionary of true/false flags. <span class="in">`md.flags[flag][md.idcs[vn]]`</span> is the</span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>    value of <span class="in">`flag`</span> corresponding to <span class="in">`vn`</span>.</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>Note that in order to make <span class="in">`md::Metadata`</span> type stable, all the <span class="in">`md.vns`</span> must have the same symbol and distribution type. However, one can have a single Julia variable, e.g. <span class="in">`x`</span>, that is a matrix or a hierarchical array sampled in partitions, e.g. <span class="in">`x[1][:] ~ MvNormal(zeros(2), I); x[2][:] ~ MvNormal(ones(2), I)`</span>. The symbol <span class="in">`x`</span> can still be managed by a single <span class="in">`md::Metadata`</span> without hurting the type stability since all the distributions on the RHS of <span class="in">`~`</span> are of the same type.</span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>However, in <span class="in">`Turing`</span> models one cannot have this restriction, so we must use a type unstable <span class="in">`Metadata`</span> if we want to use one <span class="in">`Metadata`</span> instance for the whole model. This is what <span class="in">`UntypedVarInfo`</span> does. A type unstable <span class="in">`Metadata`</span> will still work but will have inferior performance.</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>To strike a balance between flexibility and performance when constructing the <span class="in">`spl::Sampler`</span> instance, the model is first run by sampling the parameters in <span class="in">`P`</span> from their priors using an <span class="in">`UntypedVarInfo`</span>, i.e. a type unstable <span class="in">`Metadata`</span> is used for all the variables. Then once all the symbols and distribution types have been identified, a <span class="in">`vi::TypedVarInfo`</span> is constructed where <span class="in">`vi.metadata`</span> is a <span class="in">`NamedTuple`</span> mapping each symbol in <span class="in">`P`</span> to a specialized instance of <span class="in">`Metadata`</span>. So as long as each symbol in <span class="in">`P`</span> is sampled from only one type of distributions, <span class="in">`vi::TypedVarInfo`</span> will have fully concretely typed fields which brings out the peak performance of Julia.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/docs/edit/main/developers/compiler/design-overview/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/docs/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><footer class="custom-footer">
  <div class="footer-container">
    <div class="footer-grid">
      <div class="footer-links-wrapper">
        <div class="footer-column footer-explore">
          <h5>Explore</h5>
          <a href="https://turinglang.org/docs/getting-started/">Get Started</a>
          <a href="https://turinglang.org/docs/tutorials/">Tutorials</a>
          <a href="https://turinglang.org/docs/faq/">FAQ</a>
          <a href="https://turinglang.org/library/">Libraries</a>
          <a href="https://turinglang.org/news/">News</a>
          <a href="https://turinglang.org/team/">Team</a>
        </div>

        <div class="footer-column footer-connect">
          <h5>Connect</h5>
          <a href="https://github.com/TuringLang" target="_blank" rel="noopener"><i class="bi bi-github"></i> GitHub</a>
          <a href="https://x.com/TuringLang" target="_blank" rel="noopener"><i class="bi bi-twitter-x"></i> Twitter</a>
          <a href="https://julialang.slack.com/archives/CCYDC34A0" target="_blank" rel="noopener"><i class="bi bi-slack"></i> Slack</a>
          <a href="https://discourse.julialang.org/c/domain/probprog/48" target="_blank" rel="noopener"><i class="bi bi-chat-dots"></i> Discourse</a>
        </div>
      </div>

      <div class="footer-column footer-brands">
        <h5>Supported by leading researchers</h5>
        <p>Turing.jl is developed by researchers and engineers at the following research institutions.</p>
        <div class="logo-grid">
          <a href="https://mlg.eng.cam.ac.uk/" class="partner-logo" target="_blank" rel="noopener">
            <img src="../../../assets/images/brands/university-cambridge-logo-black-example-640x132.png" alt="University of Cambridge Logo" class="brands-light-mode-logo">
            <img src="../../../assets/images/brands/university-cambridge-logo-white-example-640x133.png" alt="University of Cambridge Logo Dark" class="brands-dark-mode-logo">
          </a>
          <a href="https://www.turing.ac.uk/" class="partner-logo" target="_blank" rel="noopener">
            <img src="../../../assets/images/brands/Turing_Logo_1000x400px_Black.webp" alt="The Alan Turing Institute Logo" class="brands-light-mode-logo">
            <img src="../../../assets/images/brands/Turing_Logo_1000x400px_White.webp" alt="The Alan Turing Institute Logo Dark" class="brands-dark-mode-logo">
          </a>
        </div>
      </div>

    </div>
    <div class="footer-bottom">
      <p>Turing is created by <a href="https://mlg.eng.cam.ac.uk/hong/" target="_blank" rel="noopener">Hong Ge</a>, and maintained by the core <a href="https://turinglang.org/team/" target="_blank" rel="noopener">team</a> of developers and <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank" rel="noopener">contributors</a>.<br>© 2025 The Turing Project Contributors. <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank" rel="noopener">MIT License</a>.</p>
      <a href="https://github.com/TuringLang/docs/" target="_blank" rel="noopener" class="footer-source-link"><i class="bi bi-github"></i> Website Source</a>
    </div>
  </div>
</footer>




<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>