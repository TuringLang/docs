name: Check Turing.jl Version
on:
  pull_request:
    paths: ['_quarto.yml']
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract current minor version
        id: extract_minor_version
        run: |
          minor_version=$(grep -oP 'text:\s+"v\K\d+\.\d+' _quarto.yml)
          echo "MINOR_VERSION=$minor_version" >> $GITHUB_OUTPUT

      - name: Fetch latest minor version
        id: fetch_latest_minor
        run: |
          repo_url="https://api.github.com/repos/TuringLang/Turing.jl/releases/latest"
          latest=$(curl -s $repo_url | jq -r .tag_name)
          actual_latest_minor=${latest%.*}
          echo "LATEST_MINOR=$actual_latest_minor" >> $GITHUB_OUTPUT
          echo "LATEST=$latest" >> $GITHUB_OUTPUT

      - name: Update _quarto.yml if outdated
        id: update_quarto
        run: |
          minor_version=${{ steps.extract_minor_version.outputs.MINOR_VERSION }}
          latest_minor=${{ steps.fetch_latest_minor.outputs.LATEST_MINOR }}
          if [ "$minor_version" != "$latest_minor" ]; then
            awk -v old="v$minor_version" -v new="$latest_minor" '{gsub(old, new); print}' _quarto.yml > temp.yml && mv temp.yml _quarto.yml
            echo "Updated _quarto.yml to latest minor version: $latest_minor"
          fi

      - name: Generate diff and post comment
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # Commit the changes
          git add _quarto.yml
          git diff --cached > changes.diff
          
          if [ -s changes.diff ]; then
            pr_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
            comment_body=$(sed 's/$/\\n/' changes.diff | tr -d '\n')
            
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"body\": \"The version in _quarto.yml has been updated to the latest minor version.\\n\\n\`\`\`diff\\n${comment_body}\\n\`\`\`\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${pr_number}/comments"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
