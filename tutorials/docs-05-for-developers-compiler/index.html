<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.52">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Turing Compiler Design – Turing.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../tutorials/14-minituring/index.html" rel="next">
<link href="../../tutorials/docs-01-contributing-guide/index.html" rel="prev">
<link href="../../assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>


<link rel="stylesheet" href="../../theming/styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/docs-00-getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/00-introduction/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Library API</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter"></i></a>
    <a href="https://github.com/TuringLang/Turing.jl" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Documentation</li><li class="breadcrumb-item"><a href="../../tutorials/docs-01-contributing-guide/index.html">For Developers (PPL)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-05-for-developers-compiler/index.html">Turing Compiler Design</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Modelling Syntax and Interface</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-00-getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-14-using-turing-quick-start/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quick Start</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-12-using-turing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-mode-estimation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mode Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-09-using-turing-advanced/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced Usage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-10-using-turing-autodiff/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-13-using-turing-performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-11-using-turing-dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-15-using-turing-sampler-viz/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-16-using-turing-external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">External Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Using Turing - Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/00-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Turing</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/01-gaussian-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/02-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/03-bayesian-neural-network/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/04-hidden-markov-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/05-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/06-infinite-mixture-model/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/07-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/08-multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/09-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/10-bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/11-probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/13-seasonal-time-series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/15-gaussian-processes/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Gaussian Processes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/12-gplvm/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">For Developers (PPL)</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-01-contributing-guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to Contribute</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-05-for-developers-compiler/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Turing Compiler Design</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/14-minituring/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation I: Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/16-contexts/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation II: Contexts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-06-for-developers-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Interface Guide</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">For Developers (Inference)</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-04-for-developers-abstractmcmc-turing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How Turing implements AbstractMCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-07-for-developers-variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/docs-17-implementing-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../../versions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Versions</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../changelog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Changelog</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The model</a></li>
  </ul></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example</a>
  <ul class="collapse">
  <li><a href="#step-1-break-up-the-model-definition" id="toc-step-1-break-up-the-model-definition" class="nav-link" data-scroll-target="#step-1-break-up-the-model-definition">Step 1: Break up the model definition</a></li>
  <li><a href="#step-2-generate-the-body-of-the-internal-model-function" id="toc-step-2-generate-the-body-of-the-internal-model-function" class="nav-link" data-scroll-target="#step-2-generate-the-body-of-the-internal-model-function">Step 2: Generate the body of the internal model function</a></li>
  <li><a href="#step-3-replace-the-user-provided-function-body" id="toc-step-3-replace-the-user-provided-function-body" class="nav-link" data-scroll-target="#step-3-replace-the-user-provided-function-body">Step 3: Replace the user-provided function body</a></li>
  </ul></li>
  <li><a href="#varname" id="toc-varname" class="nav-link" data-scroll-target="#varname"><code>VarName</code></a></li>
  <li><a href="#varinfo" id="toc-varinfo" class="nav-link" data-scroll-target="#varinfo"><code>VarInfo</code></a>
  <ul class="collapse">
  <li><a href="#overview-1" id="toc-overview-1" class="nav-link" data-scroll-target="#overview-1">Overview</a></li>
  <li><a href="#metadata" id="toc-metadata" class="nav-link" data-scroll-target="#metadata"><code>Metadata</code></a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-05-for-developers-compiler/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Documentation</li><li class="breadcrumb-item"><a href="../../tutorials/docs-01-contributing-guide/index.html">For Developers (PPL)</a></li><li class="breadcrumb-item"><a href="../../tutorials/docs-05-for-developers-compiler/index.html">Turing Compiler Design</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Turing Compiler Design</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this section, the current design of Turing’s model “compiler” is described which enables Turing to perform various types of Bayesian inference without changing the model definition. The “compiler” is essentially just a macro that rewrites the user’s model definition to a function that generates a <code>Model</code> struct that Julia’s dispatch can operate on and that Julia’s compiler can successfully do type inference on for efficient machine code generation.</p>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The following terminology will be used in this section:</p>
<ul>
<li><code>D</code>: observed data variables conditioned upon in the posterior,</li>
<li><code>P</code>: parameter variables distributed according to the prior distributions, these will also be referred to as random variables,</li>
<li><code>Model</code>: a fully defined probabilistic model with input data</li>
</ul>
<p><code>Turing</code>’s <code>@model</code> macro rewrites the user-provided function definition such that it can be used to instantiate a <code>Model</code> by passing in the observed data <code>D</code>.</p>
<p>The following are the main jobs of the <code>@model</code> macro:</p>
<ol type="1">
<li>Parse <code>~</code> and <code>.~</code> lines, e.g.&nbsp;<code>y .~ Normal.(c*x, 1.0)</code></li>
<li>Figure out if a variable belongs to the data <code>D</code> and or to the parameters <code>P</code></li>
<li>Enable the handling of missing data variables in <code>D</code> when defining a <code>Model</code> and treating them as parameter variables in <code>P</code> instead</li>
<li>Enable the tracking of random variables using the data structures <code>VarName</code> and <code>VarInfo</code></li>
<li>Change <code>~</code>/<code>.~</code> lines with a variable in <code>P</code> on the LHS to a call to <code>tilde_assume</code> or <code>dot_tilde_assume</code></li>
<li>Change <code>~</code>/<code>.~</code> lines with a variable in <code>D</code> on the LHS to a call to <code>tilde_observe</code> or <code>dot_tilde_observe</code></li>
<li>Enable type stable automatic differentiation of the model using type parameters</li>
</ol>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>A <code>model::Model</code> is a callable struct that one can sample from by calling</p>
<div id="4" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(model<span class="op">::</span><span class="dt">Model</span>)([rng, varinfo, sampler, context])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>rng</code> is a random number generator (default: <code>Random.default_rng()</code>), <code>varinfo</code> is a data structure that stores information about the random variables (default: <code>DynamicPPL.VarInfo()</code>), <code>sampler</code> is a sampling algorithm (default: <code>DynamicPPL.SampleFromPrior()</code>), and <code>context</code> is a sampling context that can, e.g., modify how the log probability is accumulated (default: <code>DynamicPPL.DefaultContext()</code>).</p>
<p>Sampling resets the log joint probability of <code>varinfo</code> and increases the evaluation counter of <code>sampler</code>. If <code>context</code> is a <code>LikelihoodContext</code>, only the log likelihood of <code>D</code> will be accumulated, whereas with <code>PriorContext</code> only the log prior probability of <code>P</code> is. With the <code>DefaultContext</code> the log joint probability of both <code>P</code> and <code>D</code> is accumulated.</p>
<p>The <code>Model</code> struct contains the four internal fields <code>f</code>, <code>args</code>, <code>defaults</code>, and <code>context</code>. When <code>model::Model</code> is called, then the internal function <code>model.f</code> is called as <code>model.f(rng, varinfo, sampler, context, model.args...)</code> (for multithreaded sampling, instead of <code>varinfo</code> a threadsafe wrapper is passed to <code>model.f</code>). The positional and keyword arguments that were passed to the user-defined model function when the model was created are saved as a <code>NamedTuple</code> in <code>model.args</code>. The default values of the positional and keyword arguments of the user-defined model functions, if any, are saved as a <code>NamedTuple</code> in <code>model.defaults</code>. They are used for constructing model instances with different arguments by the <code>logprob</code> and <code>prob</code> string macros. The <code>context</code> variable sets an evaluation context that can be used to control for instance whether log probabilities should be evaluated for the prior, likelihood, or joint probability. By default it is set to evaluate the log joint.</p>
</section>
</section>
<section id="example" class="level1">
<h1>Example</h1>
<p>Let’s take the following model as an example:</p>
<div id="6" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">~</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">1.0</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    @. x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    x[<span class="fl">3</span>] <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y <span class="op">~</span> <span class="fu">Normal</span>(p[<span class="fl">2</span>], <span class="fu">sqrt</span>(p[<span class="fl">1</span>]))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above call of the <code>@model</code> macro defines the function <code>gauss</code> with positional arguments <code>x</code>, <code>y</code>, and <code>::Type{TV}</code>, rewritten in such a way that every call of it returns a <code>model::Model</code>. Note that only the function body is modified by the <code>@model</code> macro, and the function signature is left untouched. It is also possible to implement models with keyword arguments such as</p>
<div id="8" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}; x<span class="op">=</span><span class="cn">missing</span>, y<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This would allow us to generate a model by calling <code>gauss(; x = rand(3))</code>.</p>
<p>If an argument has a default value <code>missing</code>, it is treated as a random variable. For variables which require an initialization because we need to loop or broadcast over its elements, such as <code>x</code> above, the following needs to be done:</p>
<div id="10" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> x <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="op">...</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that since <code>gauss</code> behaves like a regular function it is possible to define additional dispatches in a second step as well. For instance, we could achieve the same behaviour by</p>
<div id="12" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gauss</span>(x, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">2</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">...</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">gauss</span>(<span class="op">::</span><span class="dt">Missing</span>, y<span class="op">=</span><span class="fl">1.0</span>, <span class="op">::</span><span class="dt">Type{TV}</span>=<span class="dt">Vector</span>{<span class="dt">Float64</span>}) <span class="kw">where</span> {TV<span class="op">&lt;:</span><span class="dt">AbstractVector</span>}</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">gauss</span>(<span class="fu">TV</span>(<span class="cn">undef</span>, <span class="fl">3</span>), y, TV)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If <code>x</code> is sampled as a whole from a distribution and not indexed, e.g., <code>x ~ Normal(...)</code> or <code>x ~ MvNormal(...)</code>, there is no need to initialize it in an <code>if</code>-block.</p>
<section id="step-1-break-up-the-model-definition" class="level2">
<h2 class="anchored" data-anchor-id="step-1-break-up-the-model-definition">Step 1: Break up the model definition</h2>
<p>First, the <code>@model</code> macro breaks up the user-provided function definition using <code>DynamicPPL.build_model_info</code>. This function returns a dictionary consisting of:</p>
<ul>
<li><code>allargs_exprs</code>: The expressions of the positional and keyword arguments, without default values.</li>
<li><code>allargs_syms</code>: The names of the positional and keyword arguments, e.g., <code>[:x, :y, :TV]</code> above.</li>
<li><code>allargs_namedtuple</code>: An expression that constructs a <code>NamedTuple</code> of the positional and keyword arguments, e.g., <code>:((x = x, y = y, TV = TV))</code> above.</li>
<li><code>defaults_namedtuple</code>: An expression that constructs a <code>NamedTuple</code> of the default positional and keyword arguments, if any, e.g., <code>:((x = missing, y = 1, TV = Vector{Float64}))</code> above.</li>
<li><code>modeldef</code>: A dictionary with the name, arguments, and function body of the model definition, as returned by <code>MacroTools.splitdef</code>.</li>
</ul>
</section>
<section id="step-2-generate-the-body-of-the-internal-model-function" class="level2">
<h2 class="anchored" data-anchor-id="step-2-generate-the-body-of-the-internal-model-function">Step 2: Generate the body of the internal model function</h2>
<p>In a second step, <code>DynamicPPL.generate_mainbody</code> generates the main part of the transformed function body using the user-provided function body and the provided function arguments, without default values, for figuring out if a variable denotes an observation or a random variable. Hereby the function <code>DynamicPPL.generate_tilde</code> replaces the <code>L ~ R</code> lines in the model and the function <code>DynamicPPL.generate_dot_tilde</code> replaces the <code>@. L ~ R</code> and <code>L .~ R</code> lines in the model.</p>
<p>In the above example, <code>p[1] ~ InverseGamma(2, 3)</code> is replaced with something similar to</p>
<div id="14" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:6 =#</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> <span class="op">=</span> <span class="fu">InverseGamma</span>(<span class="fl">2</span>, <span class="fl">3</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#323"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#325"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>p, ((<span class="fl">1</span>,),))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#326"</span> <span class="op">=</span> ((<span class="fl">1</span>,),)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    p[<span class="fl">1</span>] <span class="op">=</span> (DynamicPPL.tilde_assume)(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        _rng,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        _context,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        _sampler,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##tmpright#323"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##vn#325"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        var<span class="st">"##inds#326"</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        _varinfo,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the first line is a so-called line number node that enables more helpful error messages by providing users with the exact location of the error in their model definition. Then the right hand side (RHS) of the <code>~</code> is assigned to a variable (with an automatically generated name). We check that the RHS is a distribution or an array of distributions, otherwise an error is thrown. Next we extract a compact representation of the variable with its name and index (or indices). Finally, the <code>~</code> expression is replaced with a call to <code>DynamicPPL.tilde_assume</code> since the compiler figured out that <code>p[1]</code> is a random variable using the following heuristic:</p>
<ol type="1">
<li>If the symbol on the LHS of <code>~</code>, <code>:p</code> in this case, is not among the arguments to the model, <code>(:x, :y, :T)</code> in this case, it is a random variable.</li>
<li>If the symbol on the LHS of <code>~</code>, <code>:p</code> in this case, is among the arguments to the model but has a value of <code>missing</code>, it is a random variable.</li>
<li>If the value of the LHS of <code>~</code>, <code>p[1]</code> in this case, is <code>missing</code>, then it is a random variable.</li>
<li>Otherwise, it is treated as an observation.</li>
</ol>
<p>The <code>DynamicPPL.tilde_assume</code> function takes care of sampling the random variable, if needed, and updating its value and the accumulated log joint probability in the <code>_varinfo</code> object. If <code>L ~ R</code> is an observation, <code>DynamicPPL.tilde_observe</code> is called with the same arguments except the random number generator <code>_rng</code> (since observations are never sampled).</p>
<p>A similar transformation is performed for expressions of the form <code>@. L ~ R</code> and <code>L .~ R</code>. For instance, <code>@. x[1:2] ~ Normal(p[2], sqrt(p[1]))</code> is replaced with</p>
<div id="16" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#= REPL[25]:8 =#</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">begin</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> <span class="op">=</span> <span class="fu">Normal</span>.(p[<span class="fl">2</span>], <span class="fu">sqrt</span>.(p[<span class="fl">1</span>]))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##tmpright#331"</span> isa <span class="dt">Union</span>{Distribution,<span class="dt">AbstractVector</span>{<span class="op">&lt;:</span><span class="dt">Distribution</span>}} <span class="op">||</span> <span class="fu">throw</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ArgumentError</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Right-hand side of a ~ must be subtype of Distribution or a vector of Distributions."</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##vn#333"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##inds#334"</span> <span class="op">=</span> ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    var<span class="st">"##isassumption#335"</span> <span class="op">=</span> <span class="cf">begin</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> var<span class="st">"##vn#336"</span> <span class="op">=</span> (DynamicPPL.VarName)(<span class="op">:</span>x, ((<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,),))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> !((DynamicPPL.inargnames)(var<span class="st">"##vn#336"</span>, _model)) <span class="op">||</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                (DynamicPPL.inmissings)(var<span class="st">"##vn#336"</span>, _model)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                <span class="cn">true</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">===</span> <span class="cn">missing</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var<span class="st">"##isassumption#335"</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>] <span class="op">.=</span> (DynamicPPL.dot_tilde_assume)(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            _rng,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        (DynamicPPL.dot_tilde_observe)(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            _context,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>            _sampler,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##tmpright#331"</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            x[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>],</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##vn#333"</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            var<span class="st">"##inds#334"</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            _varinfo,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main difference in the expanded code between <code>L ~ R</code> and <code>@. L ~ R</code> is that the former doesn’t assume <code>L</code> to be defined, it can be a new Julia variable in the scope, while the latter assumes <code>L</code> already exists. Moreover, <code>DynamicPPL.dot_tilde_assume</code> and <code>DynamicPPL.dot_tilde_observe</code> are called instead of <code>DynamicPPL.tilde_assume</code> and <code>DynamicPPL.tilde_observe</code>.</p>
</section>
<section id="step-3-replace-the-user-provided-function-body" class="level2">
<h2 class="anchored" data-anchor-id="step-3-replace-the-user-provided-function-body">Step 3: Replace the user-provided function body</h2>
<p>Finally, we replace the user-provided function body using <code>DynamicPPL.build_output</code>. This function uses <code>MacroTools.combinedef</code> to reassemble the user-provided function with a new function body. In the modified function body an anonymous function is created whose function body was generated in step 2 above and whose arguments are</p>
<ul>
<li>a random number generator <code>_rng</code>,</li>
<li>a model <code>_model</code>,</li>
<li>a datastructure <code>_varinfo</code>,</li>
<li>a sampler <code>_sampler</code>,</li>
<li>a sampling context <code>_context</code>,</li>
<li>and all positional and keyword arguments of the user-provided model function as positional arguments without any default values. Finally, in the new function body a <code>model::Model</code> with this anonymous function as internal function is returned.</li>
</ul>
</section>
</section>
<section id="varname" class="level1">
<h1><code>VarName</code></h1>
<p>In order to track random variables in the sampling process, <code>Turing</code> uses the <code>VarName</code> struct which acts as a random variable identifier generated at runtime. The <code>VarName</code> of a random variable is generated from the expression on the LHS of a <code>~</code> statement when the symbol on the LHS is in the set <code>P</code> of unobserved random variables. Every <code>VarName</code> instance has a type parameter <code>sym</code> which is the symbol of the Julia variable in the model that the random variable belongs to. For example, <code>x[1] ~ Normal()</code> will generate an instance of <code>VarName{:x}</code> assuming <code>x</code> is an unobserved random variable. Every <code>VarName</code> also has a field <code>indexing</code>, which stores the indices required to access the random variable from the Julia variable indicated by <code>sym</code> as a tuple of tuples. Each element of the tuple thereby contains the indices of one indexing operation (<code>VarName</code> also supports hierarchical arrays and range indexing). Some examples:</p>
<ul>
<li><code>x ~ Normal()</code> will generate a <code>VarName(:x, ())</code>.</li>
<li><code>x[1] ~ Normal()</code> will generate a <code>VarName(:x, ((1,),))</code>.</li>
<li><code>x[:,1] ~ MvNormal(zeros(2), I)</code> will generate a <code>VarName(:x, ((Colon(), 1),))</code>.</li>
<li><code>x[:,1][1+1] ~ Normal()</code> will generate a <code>VarName(:x, ((Colon(), 1), (2,)))</code>.</li>
</ul>
<p>The easiest way to manually construct a <code>VarName</code> is to use the <code>@varname</code> macro on an indexing expression, which will take the <code>sym</code> value from the actual variable name, and put the index values appropriately into the constructor.</p>
</section>
<section id="varinfo" class="level1">
<h1><code>VarInfo</code></h1>
<section id="overview-1" class="level2">
<h2 class="anchored" data-anchor-id="overview-1">Overview</h2>
<p><code>VarInfo</code> is the data structure in <code>Turing</code> that facilitates tracking random variables and certain metadata about them that are required for sampling. For instance, the distribution of every random variable is stored in <code>VarInfo</code> because we need to know the support of every random variable when sampling using HMC for example. Random variables whose distributions have a constrained support are transformed using a bijector from <a href="https://github.com/TuringLang/Bijectors.jl">Bijectors.jl</a> so that the sampling happens in the unconstrained space. Different samplers require different metadata about the random variables.</p>
<p>The definition of <code>VarInfo</code> in <code>Turing</code> is:</p>
<div id="18" class="cell" data-execution_count="0">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> VarInfo{Tmeta, Tlogp} <span class="op">&lt;:</span><span class="dt"> AbstractVarInfo</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">::</span><span class="dt">Tmeta</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    logp<span class="op">::</span><span class="dt">Base.RefValue{Tlogp}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    num_produce<span class="op">::</span><span class="dt">Base.RefValue{Int}</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the type of <code>metadata</code>, the <code>VarInfo</code> is either aliased <code>UntypedVarInfo</code> or <code>TypedVarInfo</code>. <code>metadata</code> can be either a subtype of the union type <code>Metadata</code> or a <code>NamedTuple</code> of multiple such subtypes. Let <code>vi</code> be an instance of <code>VarInfo</code>. If <code>vi isa VarInfo{&lt;:Metadata}</code>, then it is called an <code>UntypedVarInfo</code>. If <code>vi isa VarInfo{&lt;:NamedTuple}</code>, then <code>vi.metadata</code> would be a <code>NamedTuple</code> mapping each symbol in <code>P</code> to an instance of <code>Metadata</code>. <code>vi</code> would then be called a <code>TypedVarInfo</code>. The other fields of <code>VarInfo</code> include <code>logp</code> which is used to accumulate the log probability or log probability density of the variables in <code>P</code> and <code>D</code>. <code>num_produce</code> keeps track of how many observations have been made in the model so far. This is incremented when running a <code>~</code> statement when the symbol on the LHS is in <code>D</code>.</p>
</section>
<section id="metadata" class="level2">
<h2 class="anchored" data-anchor-id="metadata"><code>Metadata</code></h2>
<p>The <code>Metadata</code> struct stores some metadata about the random variables sampled. This helps query certain information about a variable such as: its distribution, which samplers sample this variable, its value and whether this value is transformed to real space or not. Let <code>md</code> be an instance of <code>Metadata</code>:</p>
<ul>
<li><code>md.vns</code> is the vector of all <code>VarName</code> instances. Let <code>vn</code> be an arbitrary element of <code>md.vns</code></li>
<li><code>md.idcs</code> is the dictionary that maps each <code>VarName</code> instance to its index in <code>md.vns</code>, <code>md.ranges</code>, <code>md.dists</code>, <code>md.orders</code> and <code>md.flags</code>.</li>
<li><code>md.vns[md.idcs[vn]] == vn</code>.</li>
<li><code>md.dists[md.idcs[vn]]</code> is the distribution of <code>vn</code>.</li>
<li><code>md.gids[md.idcs[vn]]</code> is the set of algorithms used to sample <code>vn</code>. This is used in the Gibbs sampling process.</li>
<li><code>md.orders[md.idcs[vn]]</code> is the number of <code>observe</code> statements before <code>vn</code> is sampled.</li>
<li><code>md.ranges[md.idcs[vn]]</code> is the index range of <code>vn</code> in <code>md.vals</code>.</li>
<li><code>md.vals[md.ranges[md.idcs[vn]]]</code> is the linearized vector of values of corresponding to <code>vn</code>.</li>
<li><code>md.flags</code> is a dictionary of true/false flags. <code>md.flags[flag][md.idcs[vn]]</code> is the value of <code>flag</code> corresponding to <code>vn</code>.</li>
</ul>
<p>Note that in order to make <code>md::Metadata</code> type stable, all the <code>md.vns</code> must have the same symbol and distribution type. However, one can have a single Julia variable, e.g.&nbsp;<code>x</code>, that is a matrix or a hierarchical array sampled in partitions, e.g.&nbsp;<code>x[1][:] ~ MvNormal(zeros(2), I); x[2][:] ~ MvNormal(ones(2), I)</code>. The symbol <code>x</code> can still be managed by a single <code>md::Metadata</code> without hurting the type stability since all the distributions on the RHS of <code>~</code> are of the same type.</p>
<p>However, in <code>Turing</code> models one cannot have this restriction, so we must use a type unstable <code>Metadata</code> if we want to use one <code>Metadata</code> instance for the whole model. This is what <code>UntypedVarInfo</code> does. A type unstable <code>Metadata</code> will still work but will have inferior performance.</p>
<p>To strike a balance between flexibility and performance when constructing the <code>spl::Sampler</code> instance, the model is first run by sampling the parameters in <code>P</code> from their priors using an <code>UntypedVarInfo</code>, i.e.&nbsp;a type unstable <code>Metadata</code> is used for all the variables. Then once all the symbols and distribution types have been identified, a <code>vi::TypedVarInfo</code> is constructed where <code>vi.metadata</code> is a <code>NamedTuple</code> mapping each symbol in <code>P</code> to a specialized instance of <code>Metadata</code>. So as long as each symbol in <code>P</code> is sampled from only one type of distributions, <code>vi::TypedVarInfo</code> will have fully concretely typed fields which brings out the peak performance of Julia.</p>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/turinglang\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../tutorials/docs-01-contributing-guide/index.html" class="pagination-link" aria-label="How to Contribute">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">How to Contribute</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../tutorials/14-minituring/index.html" class="pagination-link" aria-label="A Mini Turing Implementation I: Compiler">
        <span class="nav-page-text">A Mini Turing Implementation I: Compiler</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Turing is created by <a href="http://mlg.eng.cam.ac.uk/hong/" target="_blank">Hong Ge</a>, and lovingly maintained by the <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank">core team</a> of volunteers. <br> The contents of this website are © 2024 under the terms of the <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank">MIT License</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/TuringTutorials/edit/master/tutorials/docs-05-for-developers-compiler/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/TuringTutorials/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/TuringLang">
      <i class="bi bi-twitter" role="img" aria-label="Turing Twitter">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/TuringLang/Turing.jl">
      <i class="bi bi-github" role="img" aria-label="Turing GitHub">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>