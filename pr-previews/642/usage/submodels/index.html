<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Submodels – Turing.jl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../usage/custom-distribution/index.html" rel="next">
<link href="../../usage/automatic-differentiation/index.html" rel="prev">
<link href="../..//assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-a6e161b2431e1f94a14e0f5d32135a3c.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-4a17e18fdf56099d4f6da1e105f33a53.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-a6e161b2431e1f94a14e0f5d32135a3c.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-dd36dd2691aefc3bcb9975107d61685a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-efbb2b21aef954ede5966910a3c52bd6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-dd36dd2691aefc3bcb9975107d61685a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Only add button if we're on a tutorial page
  const path = window.location.pathname;
  if (path.includes('/tutorials/') || path.includes('/usage/')) {
    // Extract the notebook name from the URL
    const pathParts = path.split('/');
    const section = pathParts[pathParts.length - 2];

    // Create download button
    const downloadBtn = document.createElement('a');
    downloadBtn.className = 'btn btn-primary download-notebook-btn';
    downloadBtn.innerHTML = '<i class="bi bi-download"></i> Download as Notebook';

    // Generate GitHub raw URL for the notebook
    const baseUrl = 'https://raw.githubusercontent.com/TuringLang/docs/main';
    const notebookPath = path.replace('.html', '.ipynb');
    downloadBtn.href = baseUrl + notebookPath;
    downloadBtn.download = section + '.ipynb';

    // Insert button after title or in TOC area
    const tocTitle = document.querySelector('.toc-title');
    if (tocTitle) {
      tocTitle.parentNode.insertBefore(downloadBtn, tocTitle.nextSibling);
    } else {
      const articleHeader = document.querySelector('header.quarto-title-block');
      if (articleHeader) {
        articleHeader.appendChild(downloadBtn);
      }
    }
  }
});
</script>

<style>
.download-notebook-btn {
  display: inline-block;
  margin: 1rem 0;
  padding: 0.5rem 1rem;
  background-color: var(--bs-primary);
  color: white;
  text-decoration: none;
  border-radius: 0.25rem;
  font-size: 0.9rem;
}

.download-notebook-btn:hover {
  background-color: var(--bs-primary-dark);
  color: white;
  text-decoration: none;
}

.download-notebook-btn i {
  margin-right: 0.5rem;
}
</style>
<style>
  a {
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<meta property="og:title" content="The Turing Language">
<meta property="og:description" content="Turing.jl is a probabilistic programming language and Bayesian modelling framework for the Julia programming language.">
<meta property="og:image" content="https://turinglang.org/docs/assets/images/turing-text-logo.jpg">
<meta property="og:site_name" content="Turing.jl">
<meta property="og:image:alt" content="Turing.jl Logo">
<meta property="og:locale" content="en_GB">
<meta name="twitter:title" content="Submodels – Turing.jl">
<meta name="twitter:description" content="Turing.jl is a probabilistic programming language and Bayesian modelling framework for the Julia programming language.">
<meta name="twitter:image" content="https://turinglang.org/docs/assets/images/turing-text-logo.jpg">
<meta name="twitter:creator" content="@Hong_Ge2">
<meta name="twitter:site" content="@TuringLang">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="https://turinglang.org/" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo light-content">
    <img src="../../assets/images/turing-logo.svg" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="https://turinglang.org/">
    <span class="navbar-title">Turing.jl</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../getting-started/"> 
<span class="menu-text">Get Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials/"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../faq/"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/library/"> 
<span class="menu-text">Libraries</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/news/"> 
<span class="menu-text">News</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://turinglang.org/team/"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-v0.39" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">v0.39</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-v0.39">    
        <li>
    <a class="dropdown-item" href="https://turinglang.org/docs/changelog.html">
 <span class="dropdown-text">Changelog</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://turinglang.org/docs/versions.html">
 <span class="dropdown-text">All Versions</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="https://x.com/TuringLang" title="Turing Twitter" class="quarto-navigation-tool px-1" aria-label="Turing Twitter"><i class="bi bi-twitter-x"></i></a>
    <a href="https://discourse.julialang.org/c/domain/probprog/48" title="Turing Discourse" class="quarto-navigation-tool px-1" aria-label="Turing Discourse"><i class="bi bi-chat-dots"></i></a>
    <a href="https://julialang.slack.com/archives/CCYDC34A0" title="Turing Slack" class="quarto-navigation-tool px-1" aria-label="Turing Slack"><i class="bi bi-slack"></i></a>
    <a href="https://github.com/TuringLang" title="Turing GitHub" class="quarto-navigation-tool px-1" aria-label="Turing GitHub"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../usage/automatic-differentiation/index.html">User Guide</a></li><li class="breadcrumb-item"><a href="../../usage/submodels/index.html">Submodels</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../getting-started/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../core-functionality/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core Functionality</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">User Guide</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/automatic-differentiation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Automatic Differentiation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/submodels/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Submodels</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/custom-distribution/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom Distributions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/probability-interface/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Querying Model Probabilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/modifying-logprob/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modifying the Log Probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/tracking-extra-quantities/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tracking Extra Quantities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/mode-estimation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mode Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/performance-tips/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Performance Tips</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/sampler-visualisation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampler Visualization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/dynamichmc/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using DynamicHMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/external-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using External Samplers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../usage/troubleshooting/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Troubleshooting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/coin-flipping/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction: Coin Flipping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/gaussian-mixture-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-neural-networks/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Neural Networks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/hidden-markov-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hidden Markov Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-linear-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/infinite-mixture-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Infinite Mixture Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-poisson-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Poisson Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/multinomial-logistic-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multinomial Logistic Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-differential-equations/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Differential Equations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/probabilistic-pca/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probabilistic PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/bayesian-time-series-analysis/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bayesian Time Series Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/gaussian-processes-introduction/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Processes: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../tutorials/gaussian-process-latent-variable-models/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Process Latent Variable Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Developers</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/contributing/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Contributing</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">DynamicPPL’s Compiler</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/compiler/model-manual/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Manually Defining a Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/compiler/minituring-compiler/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation I: Compiler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/compiler/minituring-contexts/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">A Mini Turing Implementation II: Contexts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/compiler/design-overview/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Turing Compiler Design (Outdated)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">DynamicPPL Contexts</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/contexts/submodel-condition/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditioning and fixing in submodels</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Variable Transformations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/transforms/distributions/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Distributions and the Jacobian</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/transforms/bijectors/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bijectors in MCMC</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/transforms/dynamicppl/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variable transformations in DynamicPPL</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Inference in Detail</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/inference/variational-inference/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Variational Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../developers/inference/implementing-samplers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implementing Samplers</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#manipulating-submodels" id="toc-manipulating-submodels" class="nav-link active" data-scroll-target="#manipulating-submodels">Manipulating submodels</a>
  <ul class="collapse">
  <li><a href="#conditioning" id="toc-conditioning" class="nav-link" data-scroll-target="#conditioning">Conditioning</a></li>
  <li><a href="#prefixing" id="toc-prefixing" class="nav-link" data-scroll-target="#prefixing">Prefixing</a></li>
  </ul></li>
  <li><a href="#accessing-submodel-variables" id="toc-accessing-submodel-variables" class="nav-link" data-scroll-target="#accessing-submodel-variables">Accessing submodel variables</a></li>
  <li><a href="#example-linear-models" id="toc-example-linear-models" class="nav-link" data-scroll-target="#example-linear-models">Example: linear models</a></li>
  <li><a href="#submodels-versus-distributions" id="toc-submodels-versus-distributions" class="nav-link" data-scroll-target="#submodels-versus-distributions">Submodels versus distributions</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/TuringLang/docs/edit/main/usage/submodels/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/docs/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../usage/automatic-differentiation/index.html">User Guide</a></li><li class="breadcrumb-item"><a href="../../usage/submodels/index.html">Submodels</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Submodels</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>: Xoshiro, seed!</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">seed!</span>(<span class="fl">468</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Random.TaskLocalRNG()</code></pre>
</div>
</div>
<p>In Turing.jl, you can define models and use them as components of larger models (i.e., <em>submodels</em>), using the <code>to_submodel</code> function. In this way, you can (for example) define a model once and use it in multiple places:</p>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> <span class="fl">100</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer</span>()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This line adds the variable `x.a` to the chain.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The inner variable `a` is prefixed with the</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># left-hand side of the `~` operator, i.e. `x`.</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, the value of x will be `a + 100` because</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that is the return value of the submodel.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>outer (generic function with 2 methods)</code></pre>
</div>
</div>
<p>If we sample from this model, we would expect that <code>x.a</code> should be close to zero, and <code>b</code> close to 100:</p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">outer</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(var"x.a" = 0.07200886749732076, b = 99.9979651109378)</code></pre>
</div>
</div>
<section id="manipulating-submodels" class="level2">
<h2 class="anchored" data-anchor-id="manipulating-submodels">Manipulating submodels</h2>
<section id="conditioning" class="level3">
<h3 class="anchored" data-anchor-id="conditioning">Conditioning</h3>
<p>In general, everything that can be done to a model ‘carries over’ to when it is used as a submodel. For example, you can condition a variable in a submodel in two ways:</p>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># From the outside; the prefix `x` must be applied because</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from the perspective of `outer`, the variable is called</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `x.a`.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>outer_conditioned1 <span class="op">=</span> <span class="fu">outer</span>() <span class="op">|</span> (<span class="pp">@varname</span>(x.a) <span class="op">=&gt;</span> <span class="fl">1</span>);</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), outer_conditioned1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(b = 101.07200886749732,)</code></pre>
</div>
</div>
<p>Or equivalently, from the inside:</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_conditioned2</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The prefix doesn't need to be applied here because</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `inner` itself has no knowledge of the prefix.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>() <span class="op">|</span> (<span class="pp">@varname</span>(a) <span class="op">=&gt;</span> <span class="fl">1</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_conditioned2</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(b = 101.07200886749732,)</code></pre>
</div>
</div>
<p>In both cases the variable <code>x.a</code> does not appear.</p>
<p>Note, however, that you cannot condition on the return value of a submodel. Thus, for example, if we had:</p>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner_sensible</span>()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer</span>()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>outer (generic function with 2 methods)</code></pre>
</div>
</div>
<p>and we tried to condition on <code>x</code>, it would be silently ignored, even though <code>x</code> is equal to <code>a</code>.</p>
<p>The reason for this is because it is entirely coincidental that the return value of the submodel is equal to <code>a</code>. In general, a return value can be anything, and conditioning on it is in general not a meaningful operation.</p>
</section>
<section id="prefixing" class="level3">
<h3 class="anchored" data-anchor-id="prefixing">Prefixing</h3>
<p>Prefixing is the only place where submodel behaviour is ‘special’ compared to that of ordinary models.</p>
<p>By default, all variables in a submodel are prefixed with the left-hand side of the tilde-statement. This is done to avoid clashes if the same submodel is used multiple times in a model.</p>
<p>You can disable this by passing <code>false</code> as the second argument to <code>to_submodel</code>:</p>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_no_prefix</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>(), <span class="cn">false</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">outer_no_prefix</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(a = 0.6327762377562545, b = 99.65279863588333)</code></pre>
</div>
</div>
</section>
</section>
<section id="accessing-submodel-variables" class="level2">
<h2 class="anchored" data-anchor-id="accessing-submodel-variables">Accessing submodel variables</h2>
<p>In all of the examples above, <code>x</code> is equal to <code>a + 100</code> because that is the return value of the submodel. To access the actual latent variables in the submodel itself, the simplest option is to include the variable in the return value of the submodel:</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner_with_retval</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># You can return anything you like from the model,</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but if you want to access the latent variables, they</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># should be included in the return value.</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (; a<span class="op">=</span>a, a_plus_100<span class="op">=</span>a <span class="op">+</span> <span class="fl">100</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_with_retval</span>()</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The variable `x` will now contain the return value of the submodel,</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is a named tuple with `a` and `a_plus_100`.</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner_with_retval</span>())</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># You can access the value of x.a directly, because</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x is a NamedTuple which contains `a`. Since `b` is</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centred on `x.a`, it should be close to 0, not 100.</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x.a)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_with_retval</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(var"x.a" = 0.07200886749732076, b = -0.0020348890621966487)</code></pre>
</div>
</div>
<p>You can also manually access the value by looking inside the special <code>__varinfo__</code> object.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This relies on DynamicPPL internals and we do not recommend doing this unless you have no other option, e.g., if the submodel is defined in a different package which you do not control.</p>
</div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_with_varinfo</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Access the value of x.a</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    a_value <span class="op">=</span> __varinfo__[<span class="pp">@varname</span>(x.a)]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(a_value)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_with_varinfo</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(var"x.a" = 0.07200886749732076, b = -0.0020348890621966487)</code></pre>
</div>
</div>
</section>
<section id="example-linear-models" class="level2">
<h2 class="anchored" data-anchor-id="example-linear-models">Example: linear models</h2>
<p>Here is a motivating example for the use of submodels. Suppose we want to fit a (very simplified) regression model to some data <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, where</p>
<p><span class="math display">\[\begin{align}
c_0 &amp;\sim \text{Normal}(0, 5) \\
c_1 &amp;\sim \text{Normal}(0, 5) \\
\mu &amp;= c_0 + c_1x \\
y &amp;\sim d
\end{align}\]</span></p>
<p>where <span class="math inline">\(d\)</span> is <em>some</em> distribution parameterised by the value of <span class="math inline">\(\mu\)</span>, which we don’t know the exact form of.</p>
<p>In practice, what we would do is to write several different models, one for each function <span class="math inline">\(f\)</span>:</p>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal</span>(x, y)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume that y = mu, and that the noise in `y` is</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normally distributed with standard deviation sigma</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(mu[i], sigma)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson</span>(x, y)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exponentiate mu because the rate parameter of</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a Poisson distribution must be positive</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(mu[i]))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># and so on...</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>logpoisson (generic function with 2 methods)</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You could use <code>arraydist</code> to avoid the loops: for example, in <code>logpoisson</code>, one could write <code>y ~ arraydist(Poisson.(exp.(mu)))</code>, but for simplicity in this tutorial we spell it out fully.</p>
</div>
</div>
<p>We would then fit all of our models and use some criterion to test which model is most suitable (see e.g.&nbsp;<a href="https://en.wikipedia.org/wiki/Model_selection">Wikipedia</a>, or section 3.4 of Bishop’s <em>Pattern Recognition and Machine Learning</em>).</p>
<p>However, the code above is quite repetitive. For example, if we wanted to adjust the priors on <code>c0</code> and <code>c1</code>, we would have to do it in each model separately. If this was any other kind of code, we would naturally think of extracting the common parts into a separate function. In this case we can do exactly that with a submodel:</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">priors</span>(x)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (; c0<span class="op">=</span>c0, c1<span class="op">=</span>c1, mu<span class="op">=</span>mu)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal</span>(x, y)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(ps.mu[i], sigma)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson</span>(x, y)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(ps.mu[i]))</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>logpoisson (generic function with 2 methods)</code></pre>
</div>
</div>
<p>One could go even further and extract the <code>y</code> section into its own submodel as well, which would bring us to a generalised linear modelling interface that does not actually require the user to define their own Turing models at all:</p>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal_family</span>(mu, y)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(mu[i], sigma)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson_family</span>(mu, y)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(mu[i]))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># An end-user could just use this function. Of course,</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># a more thorough interface would also allow the user to</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co"># specify priors, etc.</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">make_model</span>(x, y, family<span class="op">::</span><span class="dt">Symbol</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> family <span class="op">==</span> <span class="op">:</span>normal</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        family_model <span class="op">=</span> normal_family</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> family <span class="op">==</span> <span class="op">:</span>logpoisson</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        family_model <span class="op">=</span> logpoisson_family</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">error</span>(<span class="st">"unknown family: `</span><span class="sc">$</span>family<span class="st">`"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@model</span> <span class="kw">function</span> <span class="fu">general</span>(x, y)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        ps <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x), <span class="cn">false</span>)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        _n <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">family_model</span>(ps.mu, y), <span class="cn">false</span>)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">general</span>(x, y)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">make_model</span>([<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>], [<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>], <span class="op">:</span>normal), <span class="fu">NUTS</span>(), <span class="fl">1000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-cyan-fg ansi-bold">┌ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>Found initial step size
<span class="ansi-cyan-fg ansi-bold">└ </span>  ϵ = 0.05
</pre>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Chains MCMC chain (1000×15×1 Array{Float64, 3}):

Iterations        = 501:1:1500
Number of chains  = 1
Samples per chain = 1000
Wall duration     = 8.7 seconds
Compute duration  = 8.7 seconds
parameters        = c0, c1, sigma
internals         = lp, n_steps, is_accept, acceptance_rate, log_density, hamiltonian_energy, hamiltonian_energy_error, max_hamiltonian_energy_error, tree_depth, numerical_error, step_size, nom_step_size

Use `describe(chains)` for summary statistics and quantiles.</code></pre>
</div>
</div>
<p>While this final example really showcases the composability of submodels, it also illustrates a minor syntactic drawback. In the case of the <code>family_model</code>, we do not care about its return value because it is not used anywhere else in the model. Ideally, we should therefore not need to place anything on the left-hand side of <code>to_submodel</code>. However, because the special behaviour of <code>to_submodel</code> relies on the tilde operator, and the tilde operator requires a left-hand side, we have to use a dummy variable (here <code>_n</code>).</p>
<p>Furthermore, because the left-hand side of a tilde-statement must be a valid variable name, we cannot use destructuring syntax on the left-hand side of <code>to_submodel</code>, even if the return value is a NamedTuple. Thus, for example, the following is not allowed:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(; c0, c1, mu) <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To use destructuring syntax, you would have to add a separate line:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(; c0, c1, mu) <span class="op">=</span> ps</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="submodels-versus-distributions" class="level2">
<h2 class="anchored" data-anchor-id="submodels-versus-distributions">Submodels versus distributions</h2>
<p>Finally, we end with a discussion of why some of the behaviour for submodels above has come about. This is slightly more behind-the-scenes and therefore will likely be of most interest to Turing developers.</p>
<p>Fundamentally, submodels are to be compared against distributions: both of them can appear on the right-hand side of a tilde statement. However, distributions only have one ‘output’, i.e., the value that is sampled from them:</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> <span class="fu">Normal</span>()</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(dist)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>1.4000191307576382</code></pre>
</div>
</div>
<p>Another point to bear in mind is that, given a sample from <code>dist</code>, asking for its log-probability is a meaningful calculation.</p>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logpdf</span>(dist, <span class="fu">rand</span>(dist))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-3.1959192599647603</code></pre>
</div>
</div>
<p>In contrast, models (and hence submodels) have two different outputs: the latent variables, and the return value. These are accessed respectively using <code>rand(model)</code> and <code>model()</code>:</p>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">f</span>()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"hello, world."</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">f</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>DynamicPPL.Model{typeof(f), (), (), (), Tuple{}, Tuple{}, DynamicPPL.DefaultContext}(f, NamedTuple(), NamedTuple(), DynamicPPL.DefaultContext())</code></pre>
</div>
</div>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Latent variables</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(a = -0.8394458622445402,)</code></pre>
</div>
</div>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return value</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">model</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>"hello, world."</code></pre>
</div>
</div>
<p>Just like for distributions, one can indeed ask for the log-probability of the latent variables (although we have to specify whether we want the joint, likelihood, or prior):</p>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logjoint</span>(model, <span class="fu">rand</span>(model))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>-2.1692571085470234</code></pre>
</div>
</div>
<p>But it does not make sense to ask for the log-probability of the return value (which in this case is a string, and in general, could be literally any object).</p>
<p>The fact that we have what looks like a unified notation for these is a bit of a lie, since it hides this distinction. In particular, for <code>x ~ distr</code>, <code>x</code> is assigned the value of <code>rand(distr)</code>; but for <code>y ~ submodel</code>, <code>y</code> is assigned the value of <code>submodel()</code>. This is why, for example, it is impossible to condition on <code>y</code> in <code>y ~ ...</code>; we can only condition on <code>x</code> in <code>x ~ dist</code>.</p>
<p>Eventually we would like to make this more logically consistent. In particular, it is clear that <code>y ~ submodel</code> should return not one but two objects: the latent variables and the return value. Furthermore, it should be possible to condition on the latent variables, but not on the return value. See <a href="https://github.com/TuringLang/Turing.jl/issues/2485">this issue</a> for an ongoing discussion of the best way to accomplish this.</p>
<p>It should be mentioned that extracting the latent variables from a submodel is not entirely trivial since the submodel is run using the same <code>VarInfo</code> as the parent model (i.e., we would have to do a before-and-after comparison to see which <em>new</em> variables were added by the submodel).</p>
<p>Also, we are still working out the exact data structure that should be used to represent the latent variables. In the examples above <code>rand(model)</code> returns a <code>NamedTuple</code>, but this actually causes loss of information because the keys of a <code>NamedTuple</code> are <code>Symbol</code>s, whereas we really want to use <code>VarName</code>s. See <a href="https://github.com/TuringLang/DynamicPPL.jl/issues/900">this issue</a> for a current proposal.</p>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/turinglang\.org\/docs");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../usage/automatic-differentiation/index.html" class="pagination-link" aria-label="Automatic Differentiation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Automatic Differentiation</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../usage/custom-distribution/index.html" class="pagination-link" aria-label="Custom Distributions">
        <span class="nav-page-text">Custom Distributions</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Submodels</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span>: Xoshiro, seed!</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">seed!</span>(<span class="fl">468</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>In Turing.jl, you can define models and use them as components of larger models (i.e., _submodels_), using the <span class="in">`to_submodel`</span> function.</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>In this way, you can (for example) define a model once and use it in multiple places:</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner</span>()</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> <span class="fl">100</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer</span>()</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This line adds the variable `x.a` to the chain.</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The inner variable `a` is prefixed with the</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># left-hand side of the `~` operator, i.e. `x`.</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, the value of x will be `a + 100` because</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that is the return value of the submodel.</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>If we sample from this model, we would expect that <span class="in">`x.a`</span> should be close to zero, and <span class="in">`b`</span> close to 100:</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">outer</span>())</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a><span class="fu">## Manipulating submodels</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conditioning</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>In general, everything that can be done to a model 'carries over' to when it is used as a submodel.</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>For example, you can condition a variable in a submodel in two ways:</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span class="co"># From the outside; the prefix `x` must be applied because</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a><span class="co"># from the perspective of `outer`, the variable is called</span></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a><span class="co"># `x.a`.</span></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>outer_conditioned1 <span class="op">=</span> <span class="fu">outer</span>() <span class="op">|</span> (<span class="pp">@varname</span>(x.a) <span class="op">=&gt;</span> <span class="fl">1</span>);</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), outer_conditioned1)</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>Or equivalently, from the inside:</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_conditioned2</span>()</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The prefix doesn't need to be applied here because</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `inner` itself has no knowledge of the prefix.</span></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>() <span class="op">|</span> (<span class="pp">@varname</span>(a) <span class="op">=&gt;</span> <span class="fl">1</span>))</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_conditioned2</span>())</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>In both cases the variable <span class="in">`x.a`</span> does not appear.</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>Note, however, that you cannot condition on the return value of a submodel.</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>Thus, for example, if we had:</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner_sensible</span>()</span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a</span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer</span>()</span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>and we tried to condition on <span class="in">`x`</span>, it would be silently ignored, even though <span class="in">`x`</span> is equal to <span class="in">`a`</span>.</span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>The reason for this is because it is entirely coincidental that the return value of the submodel is equal to <span class="in">`a`</span>.</span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>In general, a return value can be anything, and conditioning on it is in general not a meaningful operation.</span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prefixing</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>Prefixing is the only place where submodel behaviour is 'special' compared to that of ordinary models.</span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>By default, all variables in a submodel are prefixed with the left-hand side of the tilde-statement.</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a>This is done to avoid clashes if the same submodel is used multiple times in a model.</span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>You can disable this by passing <span class="in">`false`</span> as the second argument to <span class="in">`to_submodel`</span>:</span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_no_prefix</span>()</span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>(), <span class="cn">false</span>)</span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x)</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">outer_no_prefix</span>())</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a><span class="fu">## Accessing submodel variables</span></span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>In all of the examples above, <span class="in">`x`</span> is equal to <span class="in">`a + 100`</span> because that is the return value of the submodel.</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>To access the actual latent variables in the submodel itself, the simplest option is to include the variable in the return value of the submodel:</span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">inner_with_retval</span>()</span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># You can return anything you like from the model,</span></span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but if you want to access the latent variables, they</span></span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># should be included in the return value.</span></span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (; a<span class="op">=</span>a, a_plus_100<span class="op">=</span>a <span class="op">+</span> <span class="fl">100</span>)</span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_with_retval</span>()</span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The variable `x` will now contain the return value of the submodel,</span></span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is a named tuple with `a` and `a_plus_100`.</span></span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner_with_retval</span>())</span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># You can access the value of x.a directly, because</span></span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x is a NamedTuple which contains `a`. Since `b` is</span></span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centred on `x.a`, it should be close to 0, not 100.</span></span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(x.a)</span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_with_retval</span>())</span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a>You can also manually access the value by looking inside the special <span class="in">`__varinfo__`</span> object.</span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning}</span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a>This relies on DynamicPPL internals and we do not recommend doing this unless you have no other option, e.g., if the submodel is defined in a different package which you do not control.</span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">outer_with_varinfo</span>()</span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a>    x <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">inner</span>())</span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Access the value of x.a</span></span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a>    a_value <span class="op">=</span> __varinfo__[<span class="pp">@varname</span>(x.a)]</span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a>    b <span class="op">~</span> <span class="fu">Normal</span>(a_value)</span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(<span class="fu">Xoshiro</span>(<span class="fl">468</span>), <span class="fu">outer_with_varinfo</span>())</span>
<span id="cb39-161"><a href="#cb39-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-162"><a href="#cb39-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-163"><a href="#cb39-163" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example: linear models</span></span>
<span id="cb39-164"><a href="#cb39-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-165"><a href="#cb39-165" aria-hidden="true" tabindex="-1"></a>Here is a motivating example for the use of submodels.</span>
<span id="cb39-166"><a href="#cb39-166" aria-hidden="true" tabindex="-1"></a>Suppose we want to fit a (very simplified) regression model to some data $x$ and $y$, where</span>
<span id="cb39-167"><a href="#cb39-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-168"><a href="#cb39-168" aria-hidden="true" tabindex="-1"></a>$$\begin{align}</span>
<span id="cb39-169"><a href="#cb39-169" aria-hidden="true" tabindex="-1"></a>c_0 &amp;\sim \text{Normal}(0, 5) <span class="sc">\\</span></span>
<span id="cb39-170"><a href="#cb39-170" aria-hidden="true" tabindex="-1"></a>c_1 &amp;\sim \text{Normal}(0, 5) <span class="sc">\\</span></span>
<span id="cb39-171"><a href="#cb39-171" aria-hidden="true" tabindex="-1"></a>\mu &amp;= c_0 + c_1x <span class="sc">\\</span></span>
<span id="cb39-172"><a href="#cb39-172" aria-hidden="true" tabindex="-1"></a>y &amp;\sim d</span>
<span id="cb39-173"><a href="#cb39-173" aria-hidden="true" tabindex="-1"></a>\end{align}$$</span>
<span id="cb39-174"><a href="#cb39-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-175"><a href="#cb39-175" aria-hidden="true" tabindex="-1"></a>where $d$ is _some_ distribution parameterised by the value of $\mu$, which we don't know the exact form of.</span>
<span id="cb39-176"><a href="#cb39-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-177"><a href="#cb39-177" aria-hidden="true" tabindex="-1"></a>In practice, what we would do is to write several different models, one for each function $f$:</span>
<span id="cb39-178"><a href="#cb39-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-181"><a href="#cb39-181" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-182"><a href="#cb39-182" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal</span>(x, y)</span>
<span id="cb39-183"><a href="#cb39-183" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-184"><a href="#cb39-184" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-185"><a href="#cb39-185" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb39-186"><a href="#cb39-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume that y = mu, and that the noise in `y` is</span></span>
<span id="cb39-187"><a href="#cb39-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># normally distributed with standard deviation sigma</span></span>
<span id="cb39-188"><a href="#cb39-188" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb39-189"><a href="#cb39-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-190"><a href="#cb39-190" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(mu[i], sigma)</span>
<span id="cb39-191"><a href="#cb39-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-192"><a href="#cb39-192" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-193"><a href="#cb39-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-194"><a href="#cb39-194" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson</span>(x, y)</span>
<span id="cb39-195"><a href="#cb39-195" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-196"><a href="#cb39-196" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-197"><a href="#cb39-197" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb39-198"><a href="#cb39-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exponentiate mu because the rate parameter of</span></span>
<span id="cb39-199"><a href="#cb39-199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a Poisson distribution must be positive</span></span>
<span id="cb39-200"><a href="#cb39-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-201"><a href="#cb39-201" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(mu[i]))</span>
<span id="cb39-202"><a href="#cb39-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-203"><a href="#cb39-203" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-204"><a href="#cb39-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-205"><a href="#cb39-205" aria-hidden="true" tabindex="-1"></a><span class="co"># and so on...</span></span>
<span id="cb39-206"><a href="#cb39-206" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-207"><a href="#cb39-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-208"><a href="#cb39-208" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb39-209"><a href="#cb39-209" aria-hidden="true" tabindex="-1"></a>You could use <span class="in">`arraydist`</span> to avoid the loops: for example, in <span class="in">`logpoisson`</span>, one could write <span class="in">`y ~ arraydist(Poisson.(exp.(mu)))`</span>, but for simplicity in this tutorial we spell it out fully.</span>
<span id="cb39-210"><a href="#cb39-210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb39-211"><a href="#cb39-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-212"><a href="#cb39-212" aria-hidden="true" tabindex="-1"></a>We would then fit all of our models and use some criterion to test which model is most suitable (see e.g. <span class="co">[</span><span class="ot">Wikipedia</span><span class="co">](https://en.wikipedia.org/wiki/Model_selection)</span>, or section 3.4 of Bishop's *Pattern Recognition and Machine Learning*).</span>
<span id="cb39-213"><a href="#cb39-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-214"><a href="#cb39-214" aria-hidden="true" tabindex="-1"></a>However, the code above is quite repetitive.</span>
<span id="cb39-215"><a href="#cb39-215" aria-hidden="true" tabindex="-1"></a>For example, if we wanted to adjust the priors on <span class="in">`c0`</span> and <span class="in">`c1`</span>, we would have to do it in each model separately.</span>
<span id="cb39-216"><a href="#cb39-216" aria-hidden="true" tabindex="-1"></a>If this was any other kind of code, we would naturally think of extracting the common parts into a separate function.</span>
<span id="cb39-217"><a href="#cb39-217" aria-hidden="true" tabindex="-1"></a>In this case we can do exactly that with a submodel:</span>
<span id="cb39-218"><a href="#cb39-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-221"><a href="#cb39-221" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-222"><a href="#cb39-222" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">priors</span>(x)</span>
<span id="cb39-223"><a href="#cb39-223" aria-hidden="true" tabindex="-1"></a>    c0 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-224"><a href="#cb39-224" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">5</span>)</span>
<span id="cb39-225"><a href="#cb39-225" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> c0 <span class="op">.+</span> c1 <span class="op">.*</span> x</span>
<span id="cb39-226"><a href="#cb39-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (; c0<span class="op">=</span>c0, c1<span class="op">=</span>c1, mu<span class="op">=</span>mu)</span>
<span id="cb39-227"><a href="#cb39-227" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-228"><a href="#cb39-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-229"><a href="#cb39-229" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal</span>(x, y)</span>
<span id="cb39-230"><a href="#cb39-230" aria-hidden="true" tabindex="-1"></a>    ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb39-231"><a href="#cb39-231" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb39-232"><a href="#cb39-232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-233"><a href="#cb39-233" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(ps.mu[i], sigma)</span>
<span id="cb39-234"><a href="#cb39-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-235"><a href="#cb39-235" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-236"><a href="#cb39-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-237"><a href="#cb39-237" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson</span>(x, y)</span>
<span id="cb39-238"><a href="#cb39-238" aria-hidden="true" tabindex="-1"></a>    ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb39-239"><a href="#cb39-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-240"><a href="#cb39-240" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(ps.mu[i]))</span>
<span id="cb39-241"><a href="#cb39-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-242"><a href="#cb39-242" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-243"><a href="#cb39-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-244"><a href="#cb39-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-245"><a href="#cb39-245" aria-hidden="true" tabindex="-1"></a>One could go even further and extract the <span class="in">`y`</span> section into its own submodel as well, which would bring us to a generalised linear modelling interface that does not actually require the user to define their own Turing models at all:</span>
<span id="cb39-246"><a href="#cb39-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-249"><a href="#cb39-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-250"><a href="#cb39-250" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">normal_family</span>(mu, y)</span>
<span id="cb39-251"><a href="#cb39-251" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Cauchy</span>(<span class="fl">0</span>, <span class="fl">3</span>); lower<span class="op">=</span><span class="fl">0</span>)</span>
<span id="cb39-252"><a href="#cb39-252" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-253"><a href="#cb39-253" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Normal</span>(mu[i], sigma)</span>
<span id="cb39-254"><a href="#cb39-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-255"><a href="#cb39-255" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb39-256"><a href="#cb39-256" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-257"><a href="#cb39-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-258"><a href="#cb39-258" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">logpoisson_family</span>(mu, y)</span>
<span id="cb39-259"><a href="#cb39-259" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb39-260"><a href="#cb39-260" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> <span class="fu">Poisson</span>(<span class="fu">exp</span>(mu[i]))</span>
<span id="cb39-261"><a href="#cb39-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-262"><a href="#cb39-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">nothing</span></span>
<span id="cb39-263"><a href="#cb39-263" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-264"><a href="#cb39-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-265"><a href="#cb39-265" aria-hidden="true" tabindex="-1"></a><span class="co"># An end-user could just use this function. Of course,</span></span>
<span id="cb39-266"><a href="#cb39-266" aria-hidden="true" tabindex="-1"></a><span class="co"># a more thorough interface would also allow the user to</span></span>
<span id="cb39-267"><a href="#cb39-267" aria-hidden="true" tabindex="-1"></a><span class="co"># specify priors, etc.</span></span>
<span id="cb39-268"><a href="#cb39-268" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">make_model</span>(x, y, family<span class="op">::</span><span class="dt">Symbol</span>)</span>
<span id="cb39-269"><a href="#cb39-269" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> family <span class="op">==</span> <span class="op">:</span>normal</span>
<span id="cb39-270"><a href="#cb39-270" aria-hidden="true" tabindex="-1"></a>        family_model <span class="op">=</span> normal_family</span>
<span id="cb39-271"><a href="#cb39-271" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> family <span class="op">==</span> <span class="op">:</span>logpoisson</span>
<span id="cb39-272"><a href="#cb39-272" aria-hidden="true" tabindex="-1"></a>        family_model <span class="op">=</span> logpoisson_family</span>
<span id="cb39-273"><a href="#cb39-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb39-274"><a href="#cb39-274" aria-hidden="true" tabindex="-1"></a>        <span class="fu">error</span>(<span class="st">"unknown family: `</span><span class="sc">$</span>family<span class="st">`"</span>)</span>
<span id="cb39-275"><a href="#cb39-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-276"><a href="#cb39-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-277"><a href="#cb39-277" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@model</span> <span class="kw">function</span> <span class="fu">general</span>(x, y)</span>
<span id="cb39-278"><a href="#cb39-278" aria-hidden="true" tabindex="-1"></a>        ps <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x), <span class="cn">false</span>)</span>
<span id="cb39-279"><a href="#cb39-279" aria-hidden="true" tabindex="-1"></a>        _n <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">family_model</span>(ps.mu, y), <span class="cn">false</span>)</span>
<span id="cb39-280"><a href="#cb39-280" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="cb39-281"><a href="#cb39-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">general</span>(x, y)</span>
<span id="cb39-282"><a href="#cb39-282" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-283"><a href="#cb39-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-284"><a href="#cb39-284" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(<span class="fu">make_model</span>([<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>], [<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>], <span class="op">:</span>normal), <span class="fu">NUTS</span>(), <span class="fl">1000</span>; progress<span class="op">=</span><span class="cn">false</span>)</span>
<span id="cb39-285"><a href="#cb39-285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-286"><a href="#cb39-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-287"><a href="#cb39-287" aria-hidden="true" tabindex="-1"></a>While this final example really showcases the composability of submodels, it also illustrates a minor syntactic drawback.</span>
<span id="cb39-288"><a href="#cb39-288" aria-hidden="true" tabindex="-1"></a>In the case of the <span class="in">`family_model`</span>, we do not care about its return value because it is not used anywhere else in the model.</span>
<span id="cb39-289"><a href="#cb39-289" aria-hidden="true" tabindex="-1"></a>Ideally, we should therefore not need to place anything on the left-hand side of <span class="in">`to_submodel`</span>.</span>
<span id="cb39-290"><a href="#cb39-290" aria-hidden="true" tabindex="-1"></a>However, because the special behaviour of <span class="in">`to_submodel`</span> relies on the tilde operator, and the tilde operator requires a left-hand side, we have to use a dummy variable (here <span class="in">`_n`</span>).</span>
<span id="cb39-291"><a href="#cb39-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-292"><a href="#cb39-292" aria-hidden="true" tabindex="-1"></a>Furthermore, because the left-hand side of a tilde-statement must be a valid variable name, we cannot use destructuring syntax on the left-hand side of <span class="in">`to_submodel`</span>, even if the return value is a NamedTuple.</span>
<span id="cb39-293"><a href="#cb39-293" aria-hidden="true" tabindex="-1"></a>Thus, for example, the following is not allowed:</span>
<span id="cb39-294"><a href="#cb39-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-295"><a href="#cb39-295" aria-hidden="true" tabindex="-1"></a><span class="in">```julia</span></span>
<span id="cb39-296"><a href="#cb39-296" aria-hidden="true" tabindex="-1"></a>(; c0, c1, mu) <span class="op">~</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb39-297"><a href="#cb39-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-298"><a href="#cb39-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-299"><a href="#cb39-299" aria-hidden="true" tabindex="-1"></a>To use destructuring syntax, you would have to add a separate line:</span>
<span id="cb39-300"><a href="#cb39-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-301"><a href="#cb39-301" aria-hidden="true" tabindex="-1"></a><span class="in">```julia</span></span>
<span id="cb39-302"><a href="#cb39-302" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> <span class="fu">to_submodel</span>(<span class="fu">priors</span>(x))</span>
<span id="cb39-303"><a href="#cb39-303" aria-hidden="true" tabindex="-1"></a>(; c0, c1, mu) <span class="op">=</span> ps</span>
<span id="cb39-304"><a href="#cb39-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-305"><a href="#cb39-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-306"><a href="#cb39-306" aria-hidden="true" tabindex="-1"></a><span class="fu">## Submodels versus distributions</span></span>
<span id="cb39-307"><a href="#cb39-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-308"><a href="#cb39-308" aria-hidden="true" tabindex="-1"></a>Finally, we end with a discussion of why some of the behaviour for submodels above has come about.</span>
<span id="cb39-309"><a href="#cb39-309" aria-hidden="true" tabindex="-1"></a>This is slightly more behind-the-scenes and therefore will likely be of most interest to Turing developers.</span>
<span id="cb39-310"><a href="#cb39-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-311"><a href="#cb39-311" aria-hidden="true" tabindex="-1"></a>Fundamentally, submodels are to be compared against distributions: both of them can appear on the right-hand side of a tilde statement.</span>
<span id="cb39-312"><a href="#cb39-312" aria-hidden="true" tabindex="-1"></a>However, distributions only have one 'output', i.e., the value that is sampled from them:</span>
<span id="cb39-313"><a href="#cb39-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-316"><a href="#cb39-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-317"><a href="#cb39-317" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> <span class="fu">Normal</span>()</span>
<span id="cb39-318"><a href="#cb39-318" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(dist)</span>
<span id="cb39-319"><a href="#cb39-319" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-320"><a href="#cb39-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-321"><a href="#cb39-321" aria-hidden="true" tabindex="-1"></a>Another point to bear in mind is that, given a sample from <span class="in">`dist`</span>, asking for its log-probability is a meaningful calculation.</span>
<span id="cb39-322"><a href="#cb39-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-325"><a href="#cb39-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-326"><a href="#cb39-326" aria-hidden="true" tabindex="-1"></a><span class="fu">logpdf</span>(dist, <span class="fu">rand</span>(dist))</span>
<span id="cb39-327"><a href="#cb39-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-328"><a href="#cb39-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-329"><a href="#cb39-329" aria-hidden="true" tabindex="-1"></a>In contrast, models (and hence submodels) have two different outputs: the latent variables, and the return value.</span>
<span id="cb39-330"><a href="#cb39-330" aria-hidden="true" tabindex="-1"></a>These are accessed respectively using <span class="in">`rand(model)`</span> and <span class="in">`model()`</span>:</span>
<span id="cb39-331"><a href="#cb39-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-334"><a href="#cb39-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-335"><a href="#cb39-335" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">f</span>()</span>
<span id="cb39-336"><a href="#cb39-336" aria-hidden="true" tabindex="-1"></a>    a <span class="op">~</span> <span class="fu">Normal</span>()</span>
<span id="cb39-337"><a href="#cb39-337" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"hello, world."</span></span>
<span id="cb39-338"><a href="#cb39-338" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb39-339"><a href="#cb39-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-340"><a href="#cb39-340" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">f</span>()</span>
<span id="cb39-341"><a href="#cb39-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-342"><a href="#cb39-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-345"><a href="#cb39-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-346"><a href="#cb39-346" aria-hidden="true" tabindex="-1"></a><span class="co"># Latent variables</span></span>
<span id="cb39-347"><a href="#cb39-347" aria-hidden="true" tabindex="-1"></a><span class="fu">rand</span>(model)</span>
<span id="cb39-348"><a href="#cb39-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-349"><a href="#cb39-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-352"><a href="#cb39-352" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-353"><a href="#cb39-353" aria-hidden="true" tabindex="-1"></a><span class="co"># Return value</span></span>
<span id="cb39-354"><a href="#cb39-354" aria-hidden="true" tabindex="-1"></a><span class="fu">model</span>()</span>
<span id="cb39-355"><a href="#cb39-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-356"><a href="#cb39-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-357"><a href="#cb39-357" aria-hidden="true" tabindex="-1"></a>Just like for distributions, one can indeed ask for the log-probability of the latent variables (although we have to specify whether we want the joint, likelihood, or prior):</span>
<span id="cb39-358"><a href="#cb39-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-361"><a href="#cb39-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb39-362"><a href="#cb39-362" aria-hidden="true" tabindex="-1"></a><span class="fu">logjoint</span>(model, <span class="fu">rand</span>(model))</span>
<span id="cb39-363"><a href="#cb39-363" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb39-364"><a href="#cb39-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-365"><a href="#cb39-365" aria-hidden="true" tabindex="-1"></a>But it does not make sense to ask for the log-probability of the return value (which in this case is a string, and in general, could be literally any object).</span>
<span id="cb39-366"><a href="#cb39-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-367"><a href="#cb39-367" aria-hidden="true" tabindex="-1"></a>The fact that we have what looks like a unified notation for these is a bit of a lie, since it hides this distinction.</span>
<span id="cb39-368"><a href="#cb39-368" aria-hidden="true" tabindex="-1"></a>In particular, for <span class="in">`x ~ distr`</span>, <span class="in">`x`</span> is assigned the value of <span class="in">`rand(distr)`</span>; but for <span class="in">`y ~ submodel`</span>, <span class="in">`y`</span> is assigned the value of <span class="in">`submodel()`</span>.</span>
<span id="cb39-369"><a href="#cb39-369" aria-hidden="true" tabindex="-1"></a>This is why, for example, it is impossible to condition on <span class="in">`y`</span> in <span class="in">`y ~ ...`</span>; we can only condition on <span class="in">`x`</span> in <span class="in">`x ~ dist`</span>.</span>
<span id="cb39-370"><a href="#cb39-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-371"><a href="#cb39-371" aria-hidden="true" tabindex="-1"></a>Eventually we would like to make this more logically consistent.</span>
<span id="cb39-372"><a href="#cb39-372" aria-hidden="true" tabindex="-1"></a>In particular, it is clear that <span class="in">`y ~ submodel`</span> should return not one but two objects: the latent variables and the return value.</span>
<span id="cb39-373"><a href="#cb39-373" aria-hidden="true" tabindex="-1"></a>Furthermore, it should be possible to condition on the latent variables, but not on the return value.</span>
<span id="cb39-374"><a href="#cb39-374" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">this issue</span><span class="co">](https://github.com/TuringLang/Turing.jl/issues/2485)</span> for an ongoing discussion of the best way to accomplish this.</span>
<span id="cb39-375"><a href="#cb39-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-376"><a href="#cb39-376" aria-hidden="true" tabindex="-1"></a>It should be mentioned that extracting the latent variables from a submodel is not entirely trivial since the submodel is run using the same <span class="in">`VarInfo`</span> as the parent model (i.e., we would have to do a before-and-after comparison to see which _new_ variables were added by the submodel).</span>
<span id="cb39-377"><a href="#cb39-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-378"><a href="#cb39-378" aria-hidden="true" tabindex="-1"></a>Also, we are still working out the exact data structure that should be used to represent the latent variables.</span>
<span id="cb39-379"><a href="#cb39-379" aria-hidden="true" tabindex="-1"></a>In the examples above <span class="in">`rand(model)`</span> returns a <span class="in">`NamedTuple`</span>, but this actually causes loss of information because the keys of a <span class="in">`NamedTuple`</span> are <span class="in">`Symbol`</span>s, whereas we really want to use <span class="in">`VarName`</span>s.</span>
<span id="cb39-380"><a href="#cb39-380" aria-hidden="true" tabindex="-1"></a>See <span class="co">[</span><span class="ot">this issue</span><span class="co">](https://github.com/TuringLang/DynamicPPL.jl/issues/900)</span> for a current proposal.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/TuringLang/docs/edit/main/usage/submodels/index.qmd" target="_blank" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/TuringLang/docs/issues/new" target="_blank" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><footer class="custom-footer">
  <div class="footer-container">
    <div class="footer-grid">
      <div class="footer-links-wrapper">
        <div class="footer-column footer-explore">
          <h5>Explore</h5>
          <a href="https://turinglang.org/docs/getting-started/">Get Started</a>
          <a href="https://turinglang.org/docs/tutorials/">Tutorials</a>
          <a href="https://turinglang.org/docs/faq/">FAQ</a>
          <a href="https://turinglang.org/library/">Libraries</a>
          <a href="https://turinglang.org/news/">News</a>
          <a href="https://turinglang.org/team/">Team</a>
        </div>

        <div class="footer-column footer-connect">
          <h5>Connect</h5>
          <a href="https://github.com/TuringLang" target="_blank" rel="noopener"><i class="bi bi-github"></i> GitHub</a>
          <a href="https://x.com/TuringLang" target="_blank" rel="noopener"><i class="bi bi-twitter-x"></i> Twitter</a>
          <a href="https://julialang.slack.com/archives/CCYDC34A0" target="_blank" rel="noopener"><i class="bi bi-slack"></i> Slack</a>
          <a href="https://discourse.julialang.org/c/domain/probprog/48" target="_blank" rel="noopener"><i class="bi bi-chat-dots"></i> Discourse</a>
        </div>
      </div>

      <div class="footer-column footer-brands">
        <h5>Supported by leading researchers</h5>
        <p>Turing.jl is developed by researchers and engineers at the following research institutions.</p>
        <div class="logo-grid">
          <a href="https://mlg.eng.cam.ac.uk/" class="partner-logo" target="_blank" rel="noopener">
            <img src="../../assets/images/brands/university-cambridge-logo-black-example-640x132.png" alt="University of Cambridge Logo" class="brands-light-mode-logo">
            <img src="../../assets/images/brands/university-cambridge-logo-white-example-640x133.png" alt="University of Cambridge Logo Dark" class="brands-dark-mode-logo">
          </a>
          <a href="https://www.turing.ac.uk/" class="partner-logo" target="_blank" rel="noopener">
            <img src="../../assets/images/brands/Turing_Logo_1000x400px_Black.webp" alt="The Alan Turing Institute Logo" class="brands-light-mode-logo">
            <img src="../../assets/images/brands/Turing_Logo_1000x400px_White.webp" alt="The Alan Turing Institute Logo Dark" class="brands-dark-mode-logo">
          </a>
        </div>
      </div>

    </div>
    <div class="footer-bottom">
      <p>Turing is created by <a href="https://mlg.eng.cam.ac.uk/hong/" target="_blank" rel="noopener">Hong Ge</a>, and maintained by the core <a href="https://turinglang.org/team/" target="_blank" rel="noopener">team</a> of developers and <a href="https://github.com/TuringLang/Turing.jl/graphs/contributors" target="_blank" rel="noopener">contributors</a>.<br>© 2025 The Turing Project Contributors. <a href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE" target="_blank" rel="noopener">MIT License</a>.</p>
      <a href="https://github.com/TuringLang/docs/" target="_blank" rel="noopener" class="footer-source-link"><i class="bi bi-github"></i> Website Source</a>
    </div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>