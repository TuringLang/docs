name: Check VERSION
on:
  pull_request:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get install jq
      - name: Check VERSION file
        id: check_version
        run: |
          # Get the current version from the VERSION file
          current_version=$(cat VERSION)
          # Fetch the latest Turing.jl release tag
          latest_tag=$(curl --silent "https://api.github.com/repos/TuringLang/Turing.jl/releases/latest" | jq -r .tag_name)
          # Compare the current version with the latest tag
          if [ "$current_version" != "$latest_tag" ]; then
            echo "Version mismatch. Please update the VERSION file to $latest_tag."
            echo "latest_tag=$latest_tag" >> $GITHUB_ENV
            echo "version_mismatch=true" >> $GITHUB_OUTPUT
          else
            echo "Version is up-to-date."
            echo "version_mismatch=false" >> $GITHUB_OUTPUT
          fi
      - name: Update VERSION file
        if: steps.check_version.outputs.version_mismatch == 'true'
        run: |
          echo "${{ env.latest_tag }}" > VERSION
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add VERSION
      - name: Suggest changes
        if: steps.check_version.outputs.version_mismatch == 'true'
        uses: parkerbxyz/suggest-changes@v1
        with:
          comment: 'Please review the changes to the VERSION file.'
          token: ${{ secrets.GITHUB_TOKEN }}